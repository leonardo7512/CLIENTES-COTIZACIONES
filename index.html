<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard V6 - Solución Definitiva (Formato CL)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f8fafc; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .scroll-area { overflow-y: auto; scrollbar-width: thin; }
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .row-hover:hover { background-color: #f1f5f9; cursor: pointer; }
        .selected-row { background-color: #eff6ff; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body class="text-gray-800">

    <div class="bg-white border-b px-6 py-4 shadow-sm z-20 shrink-0">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div class="flex items-center gap-6">
                <div class="bg-blue-600 text-white w-10 h-10 rounded-lg flex items-center justify-center shadow">
                    <i class="fas fa-database"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg text-gray-800">Monitor de Ventas</h1>
                    <div class="flex gap-6 text-sm">
                        <div>
                            <span class="text-gray-400 text-xs uppercase font-bold">Venta Neta</span>
                            <div class="font-bold text-blue-700 text-lg" id="kpi-neto">$ -</div>
                        </div>
                        <div class="border-l pl-6">
                            <span class="text-gray-400 text-xs uppercase font-bold">Venta Bruta (Ref)</span>
                            <div class="font-bold text-gray-600 text-lg" id="kpi-bruto">$ -</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                 <div id="file-status" class="text-xs font-bold text-red-500 hidden">Error de lectura</div>
                 <label class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-bold cursor-pointer transition shadow flex items-center gap-2">
                    <i class="fas fa-file-excel"></i> Subir Excel/CSV
                    <input type="file" id="upload-csv" accept=".csv,.xlsx,.xls" class="hidden" />
                </label>
            </div>
        </div>

        <!-- PESTAÑAS DE NAVEGACIÓN -->
        <div class="flex gap-2 mt-4 border-t pt-4">
            <button onclick="switchTab('ventas')" id="tab-ventas" class="px-4 py-2 text-sm font-bold rounded-lg transition bg-blue-600 text-white">
                <i class="fas fa-chart-line mr-2"></i>Ventas
            </button>
            <button onclick="switchTab('cotizaciones')" id="tab-cotizaciones" class="px-4 py-2 text-sm font-bold rounded-lg transition bg-gray-200 text-gray-600 hover:bg-gray-300">
                <i class="fas fa-file-invoice mr-2"></i>Seguimiento Cotizaciones
            </button>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-full md:w-80 bg-white border-r flex flex-col z-10 shadow-lg md:shadow-none">
            <div class="p-4 bg-gray-50 border-b">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" id="search-input" placeholder="BUSCAR CLIENTE..." 
                           class="w-full pl-9 pr-4 py-2 rounded border focus:ring-2 focus:ring-blue-500 outline-none text-sm uppercase font-semibold">
                </div>
                <div class="flex gap-2 mt-2">
                    <button onclick="filterList('risk')" class="flex-1 py-1 text-xs font-bold text-yellow-700 bg-yellow-100 rounded hover:bg-yellow-200">Riesgo</button>
                    <button onclick="filterList('active')" class="flex-1 py-1 text-xs font-bold text-green-700 bg-green-100 rounded hover:bg-green-200">Activos</button>
                    <button onclick="filterList('all')" class="flex-1 py-1 text-xs font-bold text-gray-600 bg-gray-200 rounded hover:bg-gray-300">Todos</button>
                </div>
            </div>

            <div id="clients-list" class="flex-1 scroll-area">
                <div class="p-8 text-center text-gray-400 text-sm">
                    <i class="fas fa-arrow-up mb-2"></i><br>Sube tu archivo para comenzar
                </div>
            </div>
        </div>

        <div class="flex-1 bg-gray-100 scroll-area p-6 relative">
            
            <div id="global-view" class="max-w-5xl mx-auto space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-4 flex justify-between">
                        <span>Evolución de Venta Neta</span>
                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Mensual</span>
                    </h3>
                    <div class="h-64 w-full">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-4">Top 10 Productos Más Vendidos (Unidades)</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-500 font-bold">
                                <tr>
                                    <th class="p-3">Producto</th>
                                    <th class="p-3 text-right">Cant.</th>
                                    <th class="p-3 text-right">Venta Total</th>
                                </tr>
                            </thead>
                            <tbody id="top-products-body">
                                </tbody>
                        </table>
                    </div>
                </div>

                <!-- ANÁLISIS DE MEJORES CLIENTES POR MES -->
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <h3 class="font-bold text-gray-700 flex items-center gap-2">
                            <i class="fas fa-crown text-yellow-500"></i>
                            Mejores Clientes por Mes
                        </h3>
                        <div class="flex gap-2 items-center">
                            <label class="text-sm text-gray-600 font-semibold">Compra mínima:</label>
                            <select id="umbral-cliente" onchange="renderTopClientesMes()" class="border-2 border-gray-300 rounded-lg px-3 py-1 text-sm font-bold focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="50000">$50.000</option>
                                <option value="100000">$100.000</option>
                                <option value="150000" selected>$150.000</option>
                                <option value="200000">$200.000</option>
                                <option value="500000">$500.000</option>
                            </select>
                        </div>
                    </div>
                    <div id="meses-disponibles" class="flex gap-2 mb-4 overflow-x-auto pb-2">
                        <!-- Botones de meses dinámicos -->
                    </div>
                    <div id="top-clientes-mes-container" class="hidden">
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg mb-4 border border-blue-200">
                            <h4 class="font-bold text-gray-800 mb-2" id="mes-titulo">Enero 2025</h4>
                            <div class="text-sm text-gray-700" id="mes-stats">
                                <!-- Stats del mes -->
                            </div>
                        </div>
                        <div id="top-clientes-lista" class="space-y-3">
                            <!-- Lista de clientes -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="detail-view" class="hidden max-w-5xl mx-auto animate-fade-in">
                
                <button onclick="showGlobal()" class="mb-4 text-sm font-bold text-gray-500 hover:text-blue-600 flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> Volver al Dashboard General
                </button>

                <div class="bg-white rounded-lg shadow-sm border-l-4 border-blue-500 p-6 mb-6">
                    <div class="flex justify-between items-start flex-wrap gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 leading-tight" id="det-name">NOMBRE CLIENTE</h2>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded font-mono" id="det-rut">RUT</span>
                                <span class="text-sm text-gray-500" id="det-address">Dirección</span>
                            </div>
                        </div>
                        <div id="det-status-badge" class="px-4 py-2 rounded font-bold text-white text-sm shadow">Estado</div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6 pt-4 border-t">
                        <div>
                            <div class="text-xs text-gray-400 uppercase font-bold">Total Comprado</div>
                            <div class="text-lg font-bold text-blue-600" id="det-total">$0</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400 uppercase font-bold">Última Compra</div>
                            <div class="text-sm font-bold text-gray-700" id="det-last-date">-</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400 uppercase font-bold">Días Inactivo</div>
                            <div class="text-lg font-bold text-gray-700" id="det-days">0</div>
                        </div>
                         <div>
                            <div class="text-xs text-gray-400 uppercase font-bold">Tickets</div>
                            <div class="text-lg font-bold text-gray-700" id="det-tickets">0</div>
                        </div>
                    </div>
                </div>

                <h3 class="font-bold text-gray-700 mb-3 ml-1">Historial de Compras</h3>
                <div id="invoice-history" class="space-y-3">
                    </div>

            </div>

            <!-- VISTA DE SEGUIMIENTO DE COTIZACIONES -->
            <div id="cotizaciones-view" class="hidden max-w-7xl mx-auto space-y-6">
                
                <!-- Área de carga de archivos -->
                <div class="bg-white p-6 rounded-lg shadow-sm border-2 border-dashed border-gray-300">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <i class="fas fa-upload text-blue-600"></i>
                        Cargar Archivos para Análisis
                    </h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-600 mb-2">1. Archivo de Cotizaciones (.xls)</label>
                            <label class="w-full bg-blue-50 hover:bg-blue-100 border-2 border-blue-300 text-blue-700 px-4 py-3 rounded-lg font-bold cursor-pointer transition flex items-center justify-center gap-2">
                                <i class="fas fa-file-invoice"></i>
                                <span id="cot-file-name">Seleccionar Cotizaciones</span>
                                <input type="file" id="upload-cotizaciones" accept=".xls,.xlsx" class="hidden" />
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-600 mb-2">2. Archivo de Ventas (.xlsx)</label>
                            <label class="w-full bg-green-50 hover:bg-green-100 border-2 border-green-300 text-green-700 px-4 py-3 rounded-lg font-bold cursor-pointer transition flex items-center justify-center gap-2">
                                <i class="fas fa-file-excel"></i>
                                <span id="ventas-file-name">Seleccionar Ventas</span>
                                <input type="file" id="upload-ventas-cot" accept=".xlsx,.xls,.csv" class="hidden" />
                            </label>
                        </div>
                    </div>
                    <button onclick="analizarCotizaciones()" id="btn-analizar" class="mt-4 w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-3 rounded-lg font-bold transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-chart-bar mr-2"></i>Analizar Cotizaciones
                    </button>
                </div>

                <!-- Resultados del Análisis -->
                <div id="resultados-cotizaciones" class="hidden space-y-6">
                    
                    <!-- Resumen Ejecutivo -->
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-lg shadow-lg">
                        <h3 class="font-bold text-xl mb-4 flex items-center gap-2">
                            <i class="fas fa-chart-pie"></i>
                            Resumen Ejecutivo
                        </h3>
                        <div class="grid md:grid-cols-4 gap-4">
                            <div class="bg-white/10 backdrop-blur rounded-lg p-4">
                                <div class="text-xs uppercase opacity-80 mb-1">Total Cotizaciones</div>
                                <div class="text-2xl font-bold" id="total-cotizaciones">0</div>
                            </div>
                            <div class="bg-white/10 backdrop-blur rounded-lg p-4">
                                <div class="text-xs uppercase opacity-80 mb-1">Convertidas</div>
                                <div class="text-2xl font-bold text-green-300" id="total-convertidas">0</div>
                                <div class="text-xs opacity-80" id="pct-convertidas">0%</div>
                            </div>
                            <div class="bg-white/10 backdrop-blur rounded-lg p-4">
                                <div class="text-xs uppercase opacity-80 mb-1">Sin Compra</div>
                                <div class="text-2xl font-bold text-red-300" id="total-sin-compra">0</div>
                                <div class="text-xs opacity-80" id="monto-sin-compra">$0</div>
                            </div>
                            <div class="bg-white/10 backdrop-blur rounded-lg p-4">
                                <div class="text-xs uppercase opacity-80 mb-1">Tasa Conversión</div>
                                <div class="text-2xl font-bold" id="tasa-conversion">0%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Cotizaciones SIN COMPRA (Prioridad) -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-red-500">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-exclamation-triangle text-red-500"></i>
                                Cotizaciones SIN COMPRA - Requieren Seguimiento
                                <span class="bg-red-100 text-red-700 px-2 py-1 rounded text-sm font-bold" id="count-sin-compra">0</span>
                            </h3>
                            <button onclick="descargarExcelSeguimiento()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow flex items-center gap-2">
                                <i class="fas fa-download"></i>
                                Descargar Lista Seguimiento
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-red-50 text-red-700 font-bold">
                                    <tr>
                                        <th class="p-3 text-left">N° Cot / Cliente</th>
                                        <th class="p-3 text-left">RUT</th>
                                        <th class="p-3 text-right">Monto Cotizado</th>
                                        <th class="p-3 text-center">Fecha Cotización</th>
                                        <th class="p-3 text-center">Días</th>
                                        <th class="p-3 text-left">Vendedor</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-sin-compra" class="divide-y">
                                    <!-- Datos dinámicos -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Cotizaciones CONVERTIDAS -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-green-500">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-check-circle text-green-500"></i>
                                Cotizaciones Convertidas en Venta
                                <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-sm font-bold" id="count-convertidas">0</span>
                            </h3>
                            <button onclick="descargarExcelConversiones()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow flex items-center gap-2">
                                <i class="fas fa-download"></i>
                                Descargar Conversiones
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-green-50 text-green-700 font-bold">
                                    <tr>
                                        <th class="p-3 text-left">N° Cot → Doc / Cliente</th>
                                        <th class="p-3 text-right">Cotizado</th>
                                        <th class="p-3 text-right">Vendido</th>
                                        <th class="p-3 text-right">Diferencia</th>
                                        <th class="p-3 text-center">Días Conv.</th>
                                        <th class="p-3 text-center">Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-convertidas" class="divide-y">
                                    <!-- Datos dinámicos -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>

            </div>

            <!-- MODAL DETALLE COTIZACIÓN -->
            <div id="modal-detalle-cot" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold" id="modal-titulo">Detalle de Cotización</h3>
                                <p class="text-sm opacity-90 mt-1" id="modal-subtitulo">COT-XXXX</p>
                            </div>
                            <button onclick="cerrarModalDetalle()" class="text-white hover:bg-white/20 rounded-lg p-2 transition">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div id="modal-contenido" class="space-y-4">
                            <!-- Contenido dinámico -->
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // CONFIGURACIÓN MONEDA CHILE
        const CLP = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });
        
        // ESTADO GLOBAL
        let DB = { clients: {}, salesByMonth: {}, topProducts: {}, salesByClient: {} };
        let currentList = [];
        let chartInstance = null;
        let mesSeleccionado = null;
        let clientesPorMes = {};

        // --- 1. LIMPIEZA DE NÚMEROS (CLAVE PARA EL EXITO) ---
        function parseCLP(val) {
            if (!val) return 0;
            if (typeof val === 'number') return val; // Si ya es número, retornar directo
            
            let str = val.toString().trim();
            
            // Si no tiene punto ni coma, es un número simple
            if (!str.includes('.') && !str.includes(',')) {
                return parseFloat(str) || 0;
            }
            
            // Si tiene coma, es formato chileno con coma decimal
            if (str.includes(',')) {
                // Quitar puntos de miles
                str = str.replace(/\./g, '');
                // Cambiar coma decimal por punto
                str = str.replace(',', '.');
                return parseFloat(str) || 0;
            }
            
            // Si solo tiene un punto, verificar si es decimal o separador de miles
            const parts = str.split('.');
            if (parts.length === 2) {
                // Si la parte después del punto tiene 3 dígitos exactos, es separador de miles
                if (parts[1].length === 3) {
                    str = str.replace(/\./g, '');
                } else {
                    // Es decimal
                    str = str.replace('.', '.');
                }
            } else if (parts.length > 2) {
                // Múltiples puntos = separadores de miles
                str = str.replace(/\./g, '');
            }
            
            return parseFloat(str) || 0;
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            // DD/MM/YYYY
            if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
            return new Date(dateStr);
        }

        // --- 2. CARGA DEL ARCHIVO ---
        document.getElementById('upload-csv').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // RESET
            document.getElementById('file-status').classList.add('hidden');
            document.getElementById('clients-list').innerHTML = '<div class="p-8 text-center text-blue-500 font-bold">Procesando... <i class="fas fa-spinner fa-spin"></i></div>';

            const fileName = file.name.toLowerCase();
            
            // Detectar tipo de archivo
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                // PROCESAR EXCEL
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { 
                            header: 1,
                            raw: true,  // CRÍTICO: Leer números como números, no como strings formateados
                            defval: ''
                        });
                        
                        // Convertir a formato con headers
                        if (jsonData.length < 2) {
                            alert("El archivo Excel parece vacío.");
                            return;
                        }
                        
                        const headers = jsonData[0].map(h => (h || '').toString().trim().toLowerCase());
                        const dataRows = jsonData.slice(1).map(row => {
                            const obj = {};
                            headers.forEach((h, i) => {
                                obj[h] = row[i] || '';
                            });
                            return obj;
                        });
                        
                        console.log("Excel procesado. Primera fila:", dataRows[0]);
                        processData(dataRows);
                    } catch(err) {
                        alert("Error al leer Excel: " + err.message);
                        console.error(err);
                    }
                };
                reader.readAsArrayBuffer(file);
                
            } else if (fileName.endsWith('.csv')) {
                // PROCESAR CSV
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    delimiter: ";",
                    encoding: "ISO-8859-1",
                    transformHeader: h => h.trim().toLowerCase(),
                    complete: function(results) {
                        if (results.data.length < 2) {
                            alert("El archivo CSV parece vacío.");
                            return;
                        }
                        console.log("CSV procesado. Primera fila:", results.data[0]);
                        processData(results.data);
                    },
                    error: function(err) {
                        alert("Error al leer CSV: " + err.message);
                    }
                });
            } else {
                alert("Formato no soportado. Use archivos .xlsx, .xls o .csv");
            }
        });

        // --- 3. PROCESAMIENTO INTELIGENTE ---
        function processData(rows) {
            // Reset DB
            DB = { clients: {}, salesByMonth: {}, topProducts: {}, salesByClient: {} };
            clientesPorMes = {};
            let grandTotalNeto = 0;
            let grandTotalBruto = 0;
            let maxDate = new Date(0);

            // FILTRAR FILAS DE TOTALES Y FILAS VACÍAS
            const validRows = rows.filter(row => {
                // Detectar si la fila tiene valores nulos en columnas críticas
                const hasNullCriticalFields = !row['nombre cliente'] && !row['cliente'] && !row['fecha venta'] && !row['fecha'];
                if (hasNullCriticalFields) return false;
                
                // Detectar si contiene "Total" en la columna de cantidad
                const cantidadStr = String(row['cantidad'] || '').trim().toUpperCase();
                if (cantidadStr === 'TOTAL' || cantidadStr.startsWith('=SUM')) return false;
                
                // Detectar fórmulas de Excel en campos numéricos
                const netoStr = String(row['venta total neta'] || '').trim();
                if (netoStr.startsWith('=')) return false;
                
                return true;
            });

            console.log(`Filas totales: ${rows.length}, Filas válidas: ${validRows.length}, Filas filtradas: ${rows.length - validRows.length}`);

            validRows.forEach(row => {
                // DETECCIÓN DE COLUMNAS FLEXIBLE
                // A veces "Nombre Cliente" viene como "cliente" o "razon social"
                const name = (row['nombre cliente'] || row['cliente'] || row['razon social'] || 'DESCONOCIDO').toUpperCase().trim();
                const rut = (row['cliente rut'] || row['rut'] || '').toUpperCase();
                const fechaRaw = row['fecha venta'] || row['fecha'];
                const docId = row['numero documento'] || row['folio'];
                
                // DETECCIÓN DE VALORES (Usando la función parseCLP)
                const neto = parseCLP(row['venta total neta'] || row['total neto'] || row['monto neto']);
                const bruto = parseCLP(row['venta total bruta'] || row['total'] || row['monto']);
                const prodName = row['producto / servicio + variante'] || row['producto'];
                const qty = parseCLP(row['cantidad']);
                const precioUnitario = parseCLP(row['precio neto unitario'] || row['precio unitario'] || 0);

                if (name === 'DESCONOCIDO' && neto === 0) return; // Saltar filas vacías

                // ACUMULADORES GLOBALES
                grandTotalNeto += neto;
                grandTotalBruto += bruto;

                // FECHAS
                const dateObj = parseDate(fechaRaw);
                if (dateObj) {
                    if (dateObj > maxDate) maxDate = dateObj;
                    const monthKey = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}`;
                    DB.salesByMonth[monthKey] = (DB.salesByMonth[monthKey] || 0) + neto;
                    
                    // CONSTRUIR ANÁLISIS POR CLIENTE POR MES
                    if (!clientesPorMes[monthKey]) clientesPorMes[monthKey] = {};
                    if (!clientesPorMes[monthKey][name]) {
                        clientesPorMes[monthKey][name] = {
                            nombre: name,
                            rut: rut,
                            totalMes: 0,
                            compras: 0, // número de veces que compró
                            documentos: [],
                            productos: {},
                            ultimaCompra: dateObj,
                            comprasPosterior: 0, // compras después de este mes
                            ultimaCompraPosterior: null
                        };
                    }
                    clientesPorMes[monthKey][name].totalMes += neto;
                    clientesPorMes[monthKey][name].compras++;
                    
                    // Agregar documento si no existe
                    if (docId && !clientesPorMes[monthKey][name].documentos.includes(docId)) {
                        clientesPorMes[monthKey][name].documentos.push(docId);
                    }
                    
                    // Agregar productos
                    if (prodName) {
                        if (!clientesPorMes[monthKey][name].productos[prodName]) {
                            clientesPorMes[monthKey][name].productos[prodName] = { qty: 0, total: 0 };
                        }
                        clientesPorMes[monthKey][name].productos[prodName].qty += qty;
                        clientesPorMes[monthKey][name].productos[prodName].total += neto;
                    }
                    
                    // Actualizar última compra si es posterior
                    if (dateObj > clientesPorMes[monthKey][name].ultimaCompra) {
                        clientesPorMes[monthKey][name].ultimaCompra = dateObj;
                    }
                }

                // PRODUCTOS
                if (prodName) {
                    if (!DB.topProducts[prodName]) DB.topProducts[prodName] = { qty: 0, total: 0 };
                    DB.topProducts[prodName].qty += qty;
                    DB.topProducts[prodName].total += neto;
                }

                // CLIENTES (AGRUPACIÓN)
                if (!DB.clients[name]) {
                    DB.clients[name] = {
                        name: name,
                        rut: rut,
                        address: row['cliente dirección'] || row['cliente comuna'] || '',
                        total: 0,
                        lastDate: new Date(0),
                        invoices: {} // Agrupar por documento
                    };
                }
                
                const c = DB.clients[name];
                c.total += neto;
                if (dateObj && dateObj > c.lastDate) c.lastDate = dateObj;

                // Agregar factura al cliente
                const finalDoc = docId || 'S/F';
                if (!c.invoices[finalDoc]) {
                    c.invoices[finalDoc] = { id: finalDoc, date: fechaRaw, dateObj: dateObj, total: 0, items: [] };
                }
                c.invoices[finalDoc].total += neto;
                c.invoices[finalDoc].items.push({ 
                    prod: prodName, 
                    qty: qty, 
                    val: precioUnitario || (neto / qty) // Usar precio unitario, o calcular si no existe
                });
            });

            // --- ACTUALIZAR UI ---
            
            // 1. KPIs
            document.getElementById('kpi-neto').innerText = CLP.format(grandTotalNeto);
            document.getElementById('kpi-bruto').innerText = CLP.format(grandTotalBruto);

            // 2. Gráfico
            renderChart(DB.salesByMonth);

            // 3. Top Productos
            renderTopProducts();

            // 4. Generar Lista de Clientes (Calculando riesgo)
            generateClientList(maxDate);
            
            // 5. Calcular recompras (clientes que compraron después del mes analizado)
            calcularRecompras();
            
            // 6. Renderizar botones de meses
            renderMesesDisponibles();
        }

        function generateClientList(maxDate) {
            currentList = Object.values(DB.clients).map(c => {
                const diffTime = Math.abs(maxDate - c.lastDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let status = 'active';
                if (diffDays > 90) status = 'lost';
                else if (diffDays > 45) status = 'risk';

                return { ...c, daysInactive: diffDays, status: status };
            });

            // Ordenar por venta total descendente
            currentList.sort((a,b) => b.total - a.total);
            
            renderList(currentList); // Render inicial
        }

        // --- RENDERIZADO DE LISTA LATERAL ---
        function renderList(listData) {
            const container = document.getElementById('clients-list');
            container.innerHTML = '';

            // Limitar a 100 para no saturar si hay miles
            const displayData = listData.slice(0, 100); 

            if(displayData.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-400">Sin resultados</div>';
                return;
            }

            displayData.forEach(c => {
                const div = document.createElement('div');
                
                // Color borde según estado
                let borderColor = 'border-green-500';
                let icon = '<i class="fas fa-check text-green-500"></i>';
                if(c.status === 'risk') { borderColor = 'border-yellow-500'; icon = '<i class="fas fa-exclamation text-yellow-500"></i>'; }
                if(c.status === 'lost') { borderColor = 'border-red-500'; icon = '<i class="fas fa-times text-red-500"></i>'; }

                div.className = `p-3 bg-white border-b hover:bg-blue-50 cursor-pointer border-l-4 ${borderColor} transition`;
                div.innerHTML = `
                    <div class="flex justify-between w-full">
                        <div class="font-bold text-xs text-gray-700 w-2/3 truncate" title="${c.name}">${c.name}</div>
                        <div class="text-xs font-bold text-blue-700">${CLP.format(c.total)}</div>
                    </div>
                    <div class="flex justify-between w-full mt-1 text-xs text-gray-500">
                        <span>${icon} Hace ${c.daysInactive} días</span>
                        <span>${Object.keys(c.invoices).length} Compras</span>
                    </div>
                `;
                div.onclick = () => loadClientDetail(c);
                container.appendChild(div);
            });
        }

        // --- FILTROS Y BÚSQUEDA ---
        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toUpperCase();
            const filtered = currentList.filter(c => c.name.includes(term) || c.rut.includes(term));
            renderList(filtered);
        });

        function filterList(type) {
            if(type === 'all') renderList(currentList);
            else renderList(currentList.filter(c => c.status === type));
        }

        // --- DETALLE CLIENTE ---
        function loadClientDetail(c) {
            document.getElementById('global-view').classList.add('hidden');
            document.getElementById('detail-view').classList.remove('hidden');

            document.getElementById('det-name').innerText = c.name;
            document.getElementById('det-rut').innerText = c.rut || 'S/R';
            document.getElementById('det-address').innerText = c.address;
            document.getElementById('det-total').innerText = CLP.format(c.total);
            document.getElementById('det-last-date').innerText = c.lastDate.toLocaleDateString();
            document.getElementById('det-days').innerText = c.daysInactive;
            document.getElementById('det-tickets').innerText = Object.keys(c.invoices).length;

            const badge = document.getElementById('det-status-badge');
            if(c.status === 'active') { badge.className = "px-4 py-2 rounded font-bold text-white text-sm shadow bg-green-600"; badge.innerText = "CLIENTE ACTIVO"; }
            if(c.status === 'risk') { badge.className = "px-4 py-2 rounded font-bold text-white text-sm shadow bg-yellow-500"; badge.innerText = "EN RIESGO"; }
            if(c.status === 'lost') { badge.className = "px-4 py-2 rounded font-bold text-white text-sm shadow bg-red-600"; badge.innerText = "CLIENTE PERDIDO"; }

            // Facturas
            const container = document.getElementById('invoice-history');
            container.innerHTML = '';
            
            const sortedInvoices = Object.values(c.invoices).sort((a,b) => b.dateObj - a.dateObj);
            
            sortedInvoices.forEach(inv => {
                let itemsHtml = inv.items.map(i => {
                    const subtotal = i.qty * i.val;
                    return `
                    <div class="flex justify-between text-xs py-1 border-b border-gray-100 text-gray-600">
                        <span class="w-2/3">${i.qty} x ${i.prod.substring(0,40)}</span>
                        <span class="text-right w-1/3">
                            <span class="text-gray-400">${CLP.format(i.val)}</span> = 
                            <span class="font-semibold">${CLP.format(subtotal)}</span>
                        </span>
                    </div>
                    `;
                }).join('');

                const html = `
                    <div class="bg-white border rounded p-3 hover:shadow-md transition">
                        <div class="flex justify-between font-bold text-sm text-gray-700 mb-2">
                            <div><i class="far fa-file-alt"></i> ${inv.date} (Doc: ${inv.id})</div>
                            <div class="text-blue-600">${CLP.format(inv.total)}</div>
                        </div>
                        <div class="bg-gray-50 p-2 rounded">${itemsHtml}</div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function showGlobal() {
            document.getElementById('detail-view').classList.add('hidden');
            document.getElementById('global-view').classList.remove('hidden');
        }

        // --- GRÁFICOS ---
        function renderChart(salesData) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            const sortedKeys = Object.keys(salesData).sort();
            
            if(chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedKeys,
                    datasets: [{
                        label: 'Venta Neta',
                        data: sortedKeys.map(k => salesData[k]),
                        backgroundColor: '#2563eb',
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderTopProducts() {
            const tbody = document.getElementById('top-products-body');
            tbody.innerHTML = '';
            const top = Object.entries(DB.topProducts).sort(([,a],[,b]) => b.qty - a.qty).slice(0, 10);
            
            top.forEach(([name, data]) => {
                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-3 font-medium text-gray-700 truncate max-w-xs" title="${name}">${name}</td>
                        <td class="p-3 text-right text-gray-600">${data.qty}</td>
                        <td class="p-3 text-right font-bold text-blue-600">${CLP.format(data.total)}</td>
                    </tr>
                `;
            });
        }

        // ============================================
        // ANÁLISIS DE MEJORES CLIENTES POR MES
        // ============================================
        
        function calcularRecompras() {
            // Para cada mes, verificar si los clientes compraron en meses posteriores
            const meses = Object.keys(clientesPorMes).sort();
            
            meses.forEach((mes, index) => {
                const clientes = clientesPorMes[mes];
                const mesesPosteriores = meses.slice(index + 1);
                
                Object.values(clientes).forEach(cliente => {
                    cliente.comprasPosterior = 0;
                    cliente.ultimaCompraPosterior = null;
                    
                    // Buscar en meses posteriores
                    mesesPosteriores.forEach(mesPosterior => {
                        if (clientesPorMes[mesPosterior][cliente.nombre]) {
                            cliente.comprasPosterior++;
                            const compraPosterior = clientesPorMes[mesPosterior][cliente.nombre];
                            if (!cliente.ultimaCompraPosterior || compraPosterior.ultimaCompra > cliente.ultimaCompraPosterior) {
                                cliente.ultimaCompraPosterior = compraPosterior.ultimaCompra;
                            }
                        }
                    });
                });
            });
        }
        
        function renderMesesDisponibles() {
            const container = document.getElementById('meses-disponibles');
            const meses = Object.keys(clientesPorMes).sort().reverse(); // Más reciente primero
            
            if (meses.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No hay datos disponibles</p>';
                return;
            }
            
            const mesesNombres = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            
            container.innerHTML = meses.map(mes => {
                const [year, month] = mes.split('-');
                const mesNombre = mesesNombres[parseInt(month) - 1];
                const totalClientes = Object.keys(clientesPorMes[mes]).length;
                
                return `
                    <button onclick="seleccionarMes('${mes}')" 
                            class="px-4 py-2 rounded-lg font-bold text-sm transition shadow hover:shadow-lg ${mesSeleccionado === mes ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                            id="btn-mes-${mes}">
                        ${mesNombre} ${year}
                        <div class="text-xs ${mesSeleccionado === mes ? 'opacity-90' : 'opacity-70'}">${totalClientes} clientes</div>
                    </button>
                `;
            }).join('');
            
            // Seleccionar el mes más reciente por defecto
            if (!mesSeleccionado && meses.length > 0) {
                seleccionarMes(meses[0]);
            }
        }
        
        function seleccionarMes(mes) {
            mesSeleccionado = mes;
            renderMesesDisponibles();
            renderTopClientesMes();
        }
        
        function renderTopClientesMes() {
            if (!mesSeleccionado || !clientesPorMes[mesSeleccionado]) {
                document.getElementById('top-clientes-mes-container').classList.add('hidden');
                return;
            }
            
            const umbral = parseInt(document.getElementById('umbral-cliente').value);
            const clientes = Object.values(clientesPorMes[mesSeleccionado])
                .filter(c => c.totalMes >= umbral)
                .sort((a, b) => b.totalMes - a.totalMes);
            
            // Mostrar contenedor
            document.getElementById('top-clientes-mes-container').classList.remove('hidden');
            
            // Actualizar título y stats
            const [year, month] = mesSeleccionado.split('-');
            const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const mesNombre = mesesNombres[parseInt(month) - 1];
            
            document.getElementById('mes-titulo').textContent = `${mesNombre} ${year}`;
            
            const totalVentas = clientes.reduce((sum, c) => sum + c.totalMes, 0);
            const conRecompra = clientes.filter(c => c.comprasPosterior > 0).length;
            const sinRecompra = clientes.length - conRecompra;
            
            document.getElementById('mes-stats').innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <div class="text-xs uppercase font-bold">Total Clientes</div>
                        <div class="text-2xl font-bold text-blue-600">${clientes.length}</div>
                    </div>
                    <div>
                        <div class="text-xs uppercase font-bold">Venta Total</div>
                        <div class="text-2xl font-bold text-green-600">${CLP.format(totalVentas)}</div>
                    </div>
                    <div>
                        <div class="text-xs uppercase font-bold text-green-600">Recompraron</div>
                        <div class="text-2xl font-bold text-green-600">${conRecompra} <span class="text-sm">(${clientes.length > 0 ? Math.round(conRecompra/clientes.length*100) : 0}%)</span></div>
                    </div>
                    <div>
                        <div class="text-xs uppercase font-bold text-red-600">No Recompraron</div>
                        <div class="text-2xl font-bold text-red-600">${sinRecompra} <span class="text-sm">(${clientes.length > 0 ? Math.round(sinRecompra/clientes.length*100) : 0}%)</span></div>
                    </div>
                </div>
            `;
            
            // Renderizar lista de clientes
            const container = document.getElementById('top-clientes-lista');
            container.innerHTML = clientes.map((cliente, index) => {
                const productos = Object.entries(cliente.productos).sort(([,a], [,b]) => b.total - a.total).slice(0, 3);
                const productosHtml = productos.map(([nombre, data]) => 
                    `<div class="text-xs"><strong>${data.qty}x</strong> ${nombre} (${CLP.format(data.total)})</div>`
                ).join('');
                
                const estadoRecompra = cliente.comprasPosterior > 0 
                    ? `<div class="text-green-600 font-bold"><i class="fas fa-check-circle"></i> Recompró ${cliente.comprasPosterior} ${cliente.comprasPosterior === 1 ? 'vez' : 'veces'}</div>
                       <div class="text-xs text-green-600">Última: ${cliente.ultimaCompraPosterior ? cliente.ultimaCompraPosterior.toLocaleDateString('es-CL') : '-'}</div>`
                    : `<div class="text-red-600 font-bold"><i class="fas fa-exclamation-circle"></i> NO ha recomprado</div>
                       <div class="text-xs text-red-600 mb-2">Última compra: ${cliente.ultimaCompra.toLocaleDateString('es-CL')}</div>
                       <button onclick="event.stopPropagation(); copiarMensajeRapido('${cliente.nombre.replace(/'/g, "\\'")}', '${mesSeleccionado}')" 
                               class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs font-bold transition flex items-center gap-1 mt-1">
                           <i class="fas fa-comment"></i> Copiar mensaje
                       </button>`;
                
                return `
                    <div class="bg-white border-2 ${cliente.comprasPosterior > 0 ? 'border-green-200' : 'border-red-200'} rounded-lg p-4 hover:shadow-lg transition cursor-pointer"
                         onclick="verDetalleClienteMes('${mesSeleccionado}', '${cliente.nombre.replace(/'/g, "\\'")}')">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold text-xs">#${index + 1}</span>
                                    <h4 class="font-bold text-gray-800">${cliente.nombre}</h4>
                                </div>
                                <div class="text-xs text-gray-600 font-mono">${cliente.rut}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-blue-600">${CLP.format(cliente.totalMes)}</div>
                                <div class="text-xs text-gray-600">${cliente.compras} compra${cliente.compras === 1 ? '' : 's'}</div>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-3">
                            <div>
                                <div class="text-xs text-gray-500 uppercase font-bold mb-1">Estado</div>
                                ${estadoRecompra}
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 uppercase font-bold mb-1">Documentos</div>
                                <div class="text-sm text-gray-700">${cliente.documentos.join(', ')}</div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="text-xs text-gray-500 uppercase font-bold mb-1">Top Productos</div>
                            <div class="text-gray-700">${productosHtml}</div>
                        </div>
                        
                        <div class="mt-3 pt-3 border-t text-xs text-gray-500 flex items-center gap-2">
                            <i class="fas fa-mouse-pointer"></i>
                            Click para ver historial completo
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function verDetalleClienteMes(mes, nombreCliente) {
            const cliente = clientesPorMes[mes][nombreCliente];
            if (!cliente) return;
            
            // Reutilizar el modal de cotizaciones pero con contenido personalizado
            const modal = document.getElementById('modal-detalle-cot');
            const titulo = document.getElementById('modal-titulo');
            const subtitulo = document.getElementById('modal-subtitulo');
            const contenido = document.getElementById('modal-contenido');
            
            const [year, month] = mes.split('-');
            const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const mesNombre = mesesNombres[parseInt(month) - 1];
            
            titulo.textContent = `Historial de Cliente - ${mesNombre} ${year}`;
            subtitulo.textContent = cliente.nombre;
            
            // Listar todos los productos
            const productosHtml = Object.entries(cliente.productos)
                .sort(([,a], [,b]) => b.total - a.total)
                .map(([nombre, data]) => `
                    <tr class="border-b">
                        <td class="p-2 text-sm">${nombre}</td>
                        <td class="p-2 text-center font-bold">${data.qty}</td>
                        <td class="p-2 text-right font-bold text-green-600">${CLP.format(data.total)}</td>
                    </tr>
                `).join('');
            
            // Estado de recompra
            const recompraHtml = cliente.comprasPosterior > 0 
                ? `
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-check-circle text-green-600"></i>
                            <div class="font-bold text-green-800">Cliente Activo ✅</div>
                        </div>
                        <p class="text-sm text-green-700">
                            Este cliente ha recomprado <strong>${cliente.comprasPosterior} ${cliente.comprasPosterior === 1 ? 'vez' : 'veces'}</strong> después de ${mesNombre}.
                            Su última compra fue el <strong>${cliente.ultimaCompraPosterior ? cliente.ultimaCompraPosterior.toLocaleDateString('es-CL') : '-'}</strong>.
                        </p>
                    </div>
                `
                : `
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                            <div class="font-bold text-red-800">Cliente Inactivo ⚠️</div>
                        </div>
                        <p class="text-sm text-red-700 mb-3">
                            Este cliente <strong>NO ha vuelto a comprar</strong> desde ${mesNombre} ${year}.
                            Su última compra fue el <strong>${cliente.ultimaCompra.toLocaleDateString('es-CL')}</strong>.
                        </p>
                        <div class="bg-white p-3 rounded border border-red-200">
                            <div class="font-bold text-red-800 text-xs mb-1">💡 Acción Recomendada:</div>
                            <p class="text-xs text-red-700">Contactar al cliente para reactivación, ofrecer promociones o verificar satisfacción.</p>
                        </div>
                    </div>
                    
                    <!-- MENSAJES PREDEFINIDOS -->
                    <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-comment-dots text-blue-600 text-xl"></i>
                            <h4 class="font-bold text-blue-800">Mensajes de Reactivación</h4>
                        </div>
                        <p class="text-xs text-blue-700 mb-4">Selecciona un mensaje y cópialo para enviarlo por WhatsApp, email o llamada:</p>
                        
                        <div class="space-y-3">
                            <!-- Mensaje 1: Seguimiento General -->
                            <div class="bg-white rounded-lg p-3 border border-blue-200">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="font-bold text-sm text-gray-800">📞 Seguimiento General</div>
                                    <button onclick="copiarMensaje('seguimiento', '${cliente.nombre.replace(/'/g, "\\'")}', ${cliente.totalMes})" 
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs font-bold transition flex items-center gap-1">
                                        <i class="fas fa-copy"></i> Copiar
                                    </button>
                                </div>
                                <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded">
                                    Hola, ¿cómo está? 👋<br><br>
                                    Soy de AROMAKER y le escribo para hacer seguimiento.<br><br>
                                    Vi que en ${mesNombre} nos compró algunos productos y queríamos saber ¿cómo le fue con ellos? ¿Necesita algo más?<br><br>
                                    Quedamos atentos. ¡Saludos!
                                </div>
                            </div>
                            
                            <!-- Mensaje 2: Promoción -->
                            <div class="bg-white rounded-lg p-3 border border-blue-200">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="font-bold text-sm text-gray-800">🎁 Oferta Especial</div>
                                    <button onclick="copiarMensaje('promocion', '${cliente.nombre.replace(/'/g, "\\'")}', ${cliente.totalMes})" 
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs font-bold transition flex items-center gap-1">
                                        <i class="fas fa-copy"></i> Copiar
                                    </button>
                                </div>
                                <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded">
                                    Estimado/a, buen día 👋<br><br>
                                    Le escribo de AROMAKER para ofrecerle promociones especiales.<br><br>
                                    Tenemos descuentos exclusivos para clientes frecuentes como usted. ¿Le gustaría recibir una cotización?<br><br>
                                    Quedo atento. ¡Saludos!
                                </div>
                            </div>
                            
                            <!-- Mensaje 3: Check-in Satisfacción -->
                            <div class="bg-white rounded-lg p-3 border border-blue-200">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="font-bold text-sm text-gray-800">⭐ Verificación de Satisfacción</div>
                                    <button onclick="copiarMensaje('satisfaccion', '${cliente.nombre.replace(/'/g, "\\'")}', ${cliente.totalMes})" 
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs font-bold transition flex items-center gap-1">
                                        <i class="fas fa-copy"></i> Copiar
                                    </button>
                                </div>
                                <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded">
                                    Hola, buen día 👋<br><br>
                                    Soy de AROMAKER y quisiera saber su opinión sobre su compra de ${mesNombre}.<br><br>
                                    ¿Quedó satisfecho/a con la calidad y el servicio? Su feedback es muy importante para nosotros.<br><br>
                                    Si hay algo en lo que podamos mejorar, estamos para ayudarle.<br><br>
                                    ¡Saludos cordiales!
                                </div>
                            </div>
                            
                            <!-- Mensaje 4: Recordatorio Stock -->
                            <div class="bg-white rounded-lg p-3 border border-blue-200">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="font-bold text-sm text-gray-800">📦 Recordatorio de Reposición</div>
                                    <button onclick="copiarMensaje('reposicion', '${cliente.nombre.replace(/'/g, "\\'")}', ${cliente.totalMes})" 
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs font-bold transition flex items-center gap-1">
                                        <i class="fas fa-copy"></i> Copiar
                                    </button>
                                </div>
                                <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded">
                                    Estimado/a, buen día 👋<br><br>
                                    Le escribo de AROMAKER para ver si necesita reponer stock.<br><br>
                                    Según su compra de ${mesNombre}, tal vez sea momento de una nueva orden. ¿Le preparo una cotización?<br><br>
                                    Quedamos atentos. ¡Saludos!
                                </div>
                            </div>
                            
                            <!-- Mensaje 5: Nuevos Productos -->
                            <div class="bg-white rounded-lg p-3 border border-blue-200">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="font-bold text-sm text-gray-800">✨ Novedades</div>
                                    <button onclick="copiarMensaje('novedades', '${cliente.nombre.replace(/'/g, "\\'")}', ${cliente.totalMes})" 
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs font-bold transition flex items-center gap-1">
                                        <i class="fas fa-copy"></i> Copiar
                                    </button>
                                </div>
                                <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded">
                                    Hola, buen día 👋<br><br>
                                    Le escribo de AROMAKER para contarle que tenemos novedades que podrían interesarle.<br><br>
                                    ¿Le gustaría que le envíe información sobre nuestros nuevos productos?<br><br>
                                    ¡Saludos!
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded">
                            <div class="text-xs text-green-700">
                                <i class="fas fa-lightbulb text-green-600"></i> 
                                <strong>Tip:</strong> Los mensajes son genéricos e ideales para copiar y pegar. Puedes personalizarlos agregando detalles específicos cuando los envíes.
                            </div>
                        </div>
                    </div>
                `;
            
            contenido.innerHTML = `
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-xs text-gray-500 uppercase font-bold mb-1">RUT</div>
                        <div class="font-mono text-gray-800">${cliente.rut}</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-xs text-blue-600 uppercase font-bold mb-1">Total Comprado en ${mesNombre}</div>
                        <div class="text-2xl font-bold text-blue-700">${CLP.format(cliente.totalMes)}</div>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <div class="text-xs text-purple-700 uppercase font-bold mb-1">Compras en ${mesNombre}</div>
                        <div class="text-2xl font-bold text-purple-700">${cliente.compras}</div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="text-xs text-gray-700 uppercase font-bold mb-1">Documentos</div>
                        <div class="text-sm font-bold text-gray-700">${cliente.documentos.join(', ')}</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <div class="text-xs text-green-700 uppercase font-bold mb-1">Productos Distintos</div>
                        <div class="text-2xl font-bold text-green-700">${Object.keys(cliente.productos).length}</div>
                    </div>
                </div>
                
                ${recompraHtml}
                
                <div class="mt-6">
                    <h4 class="font-bold text-gray-700 mb-3">Detalle de Productos Comprados en ${mesNombre}</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-2 text-left text-xs font-bold text-gray-600">Producto</th>
                                    <th class="p-2 text-center text-xs font-bold text-gray-600">Cantidad</th>
                                    <th class="p-2 text-right text-xs font-bold text-gray-600">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${productosHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }
        
        function copiarMensaje(tipo, nombreCliente, montoTotal) {
            // Obtener el mes seleccionado para personalizar el mensaje
            const [year, month] = mesSeleccionado.split('-');
            const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const mesNombre = mesesNombres[parseInt(month) - 1];
            
            let mensaje = '';
            
            switch(tipo) {
                case 'seguimiento':
                    mensaje = `Hola, ¿cómo está? 👋

Soy de AROMAKER y le escribo para hacer seguimiento. 

Vi que en ${mesNombre} nos compró algunos productos y queríamos saber ¿cómo le fue con ellos? ¿Necesita algo más?

Quedamos atentos. ¡Saludos!`;
                    break;
                    
                case 'promocion':
                    mensaje = `Estimado/a, buen día 👋

Le escribo de AROMAKER para ofrecerle promociones especiales. 

Tenemos descuentos exclusivos para clientes frecuentes como usted. ¿Le gustaría recibir una cotización?

Quedo atento. ¡Saludos!`;
                    break;
                    
                case 'satisfaccion':
                    mensaje = `Hola, buen día 👋

Soy de AROMAKER y quisiera saber su opinión sobre su compra de ${mesNombre}. 

¿Quedó satisfecho/a con la calidad y el servicio? Su feedback es muy importante para nosotros.

Si hay algo en lo que podamos mejorar, estamos para ayudarle.

¡Saludos cordiales!`;
                    break;
                    
                case 'reposicion':
                    mensaje = `Estimado/a, buen día 👋

Le escribo de AROMAKER para ver si necesita reponer stock.

Según su compra de ${mesNombre}, tal vez sea momento de una nueva orden. ¿Le preparo una cotización?

Quedamos atentos. ¡Saludos!`;
                    break;
                    
                case 'novedades':
                    mensaje = `Hola, buen día 👋

Le escribo de AROMAKER para contarle que tenemos novedades que podrían interesarle.

¿Le gustaría que le envíe información sobre nuestros nuevos productos?

¡Saludos!`;
                    break;
            }
            
            // Copiar al portapapeles
            navigator.clipboard.writeText(mensaje).then(() => {
                // Mostrar notificación de éxito
                mostrarNotificacion('✅ Mensaje copiado al portapapeles', 'success');
            }).catch(err => {
                // Fallback para navegadores antiguos
                const textarea = document.createElement('textarea');
                textarea.value = mensaje;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    mostrarNotificacion('✅ Mensaje copiado al portapapeles', 'success');
                } catch (e) {
                    mostrarNotificacion('❌ Error al copiar. Intenta de nuevo.', 'error');
                }
                document.body.removeChild(textarea);
            });
        }
        
        function mostrarNotificacion(texto, tipo) {
            // Crear notificación temporal
            const notif = document.createElement('div');
            notif.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg font-bold text-white transition-all duration-300 ${tipo === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            notif.textContent = texto;
            document.body.appendChild(notif);
            
            // Animar entrada
            setTimeout(() => notif.style.transform = 'translateX(0)', 10);
            
            // Remover después de 3 segundos
            setTimeout(() => {
                notif.style.opacity = '0';
                notif.style.transform = 'translateX(100%)';
                setTimeout(() => document.body.removeChild(notif), 300);
            }, 3000);
        }
        
        function copiarMensajeRapido(nombreCliente, mes) {
            // Mensaje rápido de seguimiento
            const [year, month] = mes.split('-');
            const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const mesNombre = mesesNombres[parseInt(month) - 1];
            
            const mensaje = `Hola, ¿cómo está? 👋

Soy de AROMAKER y le escribo para hacer seguimiento. 

Vi que en ${mesNombre} nos compró algunos productos y queríamos saber ¿cómo le fue con ellos? ¿Necesita algo más?

Quedamos atentos. ¡Saludos!`;
            
            navigator.clipboard.writeText(mensaje).then(() => {
                mostrarNotificacion('✅ Mensaje de seguimiento copiado', 'success');
            }).catch(err => {
                const textarea = document.createElement('textarea');
                textarea.value = mensaje;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    mostrarNotificacion('✅ Mensaje de seguimiento copiado', 'success');
                } catch (e) {
                    mostrarNotificacion('❌ Error al copiar', 'error');
                }
                document.body.removeChild(textarea);
            });
        }

        // ============================================
        // SISTEMA DE PESTAÑAS
        // ============================================
        
        function switchTab(tab) {
            // Ocultar todas las vistas
            document.getElementById('global-view').classList.add('hidden');
            document.getElementById('detail-view').classList.add('hidden');
            document.getElementById('cotizaciones-view').classList.add('hidden');
            
            // Actualizar botones
            document.getElementById('tab-ventas').className = 'px-4 py-2 text-sm font-bold rounded-lg transition bg-gray-200 text-gray-600 hover:bg-gray-300';
            document.getElementById('tab-cotizaciones').className = 'px-4 py-2 text-sm font-bold rounded-lg transition bg-gray-200 text-gray-600 hover:bg-gray-300';
            
            // Mostrar vista seleccionada y activar botón
            if (tab === 'ventas') {
                document.getElementById('global-view').classList.remove('hidden');
                document.getElementById('tab-ventas').className = 'px-4 py-2 text-sm font-bold rounded-lg transition bg-blue-600 text-white';
            } else if (tab === 'cotizaciones') {
                document.getElementById('cotizaciones-view').classList.remove('hidden');
                document.getElementById('tab-cotizaciones').className = 'px-4 py-2 text-sm font-bold rounded-lg transition bg-blue-600 text-white';
            }
        }

        // ============================================
        // ANÁLISIS DE COTIZACIONES
        // ============================================
        
        let cotizacionesData = [];
        let ventasData = [];
        let analisisResultado = null;

        // Manejo de carga de archivos
        document.getElementById('upload-cotizaciones').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('cot-file-name').textContent = file.name;
                cargarCotizaciones(file);
            }
        });

        document.getElementById('upload-ventas-cot').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('ventas-file-name').textContent = file.name;
                cargarVentas(file);
            }
        });

        function cargarCotizaciones(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', raw: true });
                    
                    console.log('📋 Hojas disponibles:', workbook.SheetNames);
                    
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, raw: false, defval: '' });
                    
                    console.log('📊 Total de filas:', jsonData.length);
                    console.log('📄 Primeras 5 filas:', jsonData.slice(0, 5));
                    
                    // Parsear cotizaciones
                    cotizacionesData = parsearCotizaciones(jsonData);
                    
                    console.log('✅ Cotizaciones parseadas:', cotizacionesData.length);
                    if (cotizacionesData.length > 0) {
                        console.log('📋 Ejemplo de cotización:', cotizacionesData[0]);
                    }
                    
                    verificarHabilitarAnalisis();
                } catch (error) {
                    console.error('❌ Error al cargar cotizaciones:', error);
                    alert('Error al leer el archivo de cotizaciones. Por favor verifica el formato.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parsearCotizaciones(rows) {
            const cotizaciones = [];
            let headerRow = -1;
            
            console.log('🔍 Buscando tabla de datos en', rows.length, 'filas');
            
            // Buscar fila de headers de la TABLA (no metadatos)
            // La tabla real tiene múltiples columnas con datos, no solo 2-3
            for (let i = 0; i < Math.min(30, rows.length); i++) {
                const row = rows[i];
                if (!row) continue;
                
                // Contar celdas no vacías
                const nonEmpty = row.filter(cell => cell && cell.toString().trim()).length;
                
                // La fila de headers de la tabla tiene muchas columnas
                if (nonEmpty > 10) {
                    const rowStr = row.join('|').toLowerCase();
                    // Debe tener headers clave de una tabla
                    if (rowStr.includes('tipo documento') && rowStr.includes('cliente') && rowStr.includes('monto')) {
                        console.log('🎯 Tabla encontrada en fila', i);
                        console.log('📋 Headers:', row.slice(0, 10));
                        headerRow = i;
                        break;
                    }
                }
            }
            
            if (headerRow === -1) {
                console.error('❌ No se encontró tabla de datos');
                return cotizaciones;
            }
            
            const headers = rows[headerRow].map(h => (h || '').toString().trim());
            console.log('📋 Total headers encontrados:', headers.length);
            
            // Mapear índices de columnas
            const indices = {
                tipo: headers.findIndex(h => h.toLowerCase() === 'tipo documento'),
                numero: headers.findIndex(h => h.toLowerCase().includes('nº documento') || h.toLowerCase() === 'nº documento'),
                cliente: headers.findIndex(h => h.toLowerCase() === 'cliente'),
                rut: headers.findIndex(h => h.toLowerCase() === 'rut cliente'),
                fecha: headers.findIndex(h => h.toLowerCase() === 'fecha emisión'),
                monto: headers.findIndex(h => h.toLowerCase() === 'monto documento'),
                estado: headers.findIndex(h => h.toLowerCase() === 'estado'),
                vendedor: headers.findIndex(h => h.toLowerCase() === 'vendedor')
            };
            
            console.log('🗺️ Índices mapeados:', indices);
            
            // Validar que encontramos los campos esenciales
            if (indices.cliente < 0 || indices.rut < 0 || indices.monto < 0) {
                console.error('❌ No se encontraron columnas esenciales');
                return cotizaciones;
            }
            
            // Procesar filas de datos
            let procesadas = 0;
            let descartadas = 0;
            
            for (let i = headerRow + 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length === 0) continue;
                
                // Verificar si es cotización
                const tipo = indices.tipo >= 0 ? (row[indices.tipo] || '').toString() : '';
                if (tipo && !tipo.toUpperCase().includes('COTIZ')) {
                    descartadas++;
                    continue;
                }
                
                // Verificar estado (ignorar anuladas)
                const estado = indices.estado >= 0 ? (row[indices.estado] || '').toString() : '';
                if (estado.toUpperCase().includes('NULO') || estado.toUpperCase().includes('ANULAD')) {
                    descartadas++;
                    continue;
                }
                
                const cliente = (row[indices.cliente] || '').toString().trim().toUpperCase();
                const rut = limpiarRUT(row[indices.rut]);
                const monto = parseCLP(row[indices.monto]);
                
                // Solo agregar si tiene datos mínimos válidos
                if (cliente && rut && monto > 0) {
                    cotizaciones.push({
                        numero: indices.numero >= 0 ? (row[indices.numero] || '').toString() : '',
                        cliente: cliente,
                        rut: rut,
                        fecha: indices.fecha >= 0 ? parsearFecha(row[indices.fecha]) : null,
                        monto: monto,
                        vendedor: indices.vendedor >= 0 ? (row[indices.vendedor] || '').toString() : '',
                        estado: estado
                    });
                    procesadas++;
                } else {
                    descartadas++;
                }
            }
            
            console.log('✅ Cotizaciones válidas:', procesadas);
            console.log('⚠️ Filas descartadas:', descartadas);
            
            if (cotizaciones.length > 0) {
                console.log('📋 Ejemplo cotización:', cotizaciones[0]);
            }
            
            return cotizaciones;
        }

        function cargarVentas(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', raw: true });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, raw: false, defval: '' });
                    
                    console.log('💰 Archivo de ventas cargado:', jsonData.length, 'filas');
                    console.log('📄 Primera fila (headers):', jsonData[0]);
                    
                    ventasData = parsearVentas(jsonData);
                    
                    console.log('✅ Ventas agrupadas:', ventasData.length);
                    if (ventasData.length > 0) {
                        console.log('💵 Ejemplo de venta:', ventasData[0]);
                    }
                    
                    verificarHabilitarAnalisis();
                } catch (error) {
                    console.error('❌ Error al cargar ventas:', error);
                    alert('Error al leer el archivo de ventas. Por favor verifica el formato.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parsearVentas(rows) {
            const ventas = [];
            if (rows.length < 2) return ventas;
            
            const headers = rows[0].map(h => (h || '').toString().trim());
            
            // Mapear índices - BUSCAR COLUMNAS ESPECÍFICAS
            const indices = {
                cliente: headers.findIndex(h => h.includes('Nombre Cliente')),
                rut: headers.findIndex(h => h.includes('Cliente RUT')),
                fecha: headers.findIndex(h => h.includes('Fecha de Emisión') || h.includes('Fecha Venta')),
                neto: headers.findIndex(h => h.includes('Venta Total Neta')),  // ESPECÍFICO
                documento: headers.findIndex(h => h.includes('Numero Documento'))
            };
            
            console.log('💰 Índices ventas:', indices);
            
            // Agrupar ventas por RUT + DOCUMENTO (para sumar items de la misma factura)
            const ventasPorDocumento = {};
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length === 0) continue;
                
                const rut = limpiarRUT(row[indices.rut]);
                const fecha = parsearFecha(row[indices.fecha]);
                const neto = parseCLP(row[indices.neto]);
                const documento = (row[indices.documento] || '').toString().trim();
                
                if (!rut || !fecha || neto === 0) continue;
                
                // Clave única: RUT + Documento (para agrupar items de la misma factura)
                const key = `${rut}_${documento}`;
                
                if (!ventasPorDocumento[key]) {
                    ventasPorDocumento[key] = {
                        cliente: (row[indices.cliente] || '').toString().trim().toUpperCase(),
                        rut: rut,
                        fecha: fecha,
                        total: 0,
                        documento: documento,
                        items: 0
                    };
                }
                
                ventasPorDocumento[key].total += neto;
                ventasPorDocumento[key].items++;
            }
            
            const ventasAgrupadas = Object.values(ventasPorDocumento);
            console.log('💰 Ventas agrupadas por documento:', ventasAgrupadas.length);
            console.log('📊 Ejemplo:', ventasAgrupadas[0]);
            
            return ventasAgrupadas;
        }

        function limpiarRUT(rut) {
            if (!rut) return '';
            return rut.toString().replace(/[.-]/g, '').trim().toUpperCase();
        }

        function parsearFecha(fecha) {
            if (!fecha) return null;
            
            // Si ya es un objeto Date válido, retornarlo
            if (fecha instanceof Date && !isNaN(fecha.getTime())) {
                return fecha;
            }
            
            const str = fecha.toString().trim();
            
            // Formato DD-MM-YYYY o DD/MM/YYYY
            const matchDMY = str.match(/(\d{1,2})[-/](\d{1,2})[-/](\d{4})/);
            if (matchDMY) {
                return new Date(matchDMY[3], matchDMY[2] - 1, matchDMY[1]);
            }
            
            // Formato YYYY-MM-DD
            const matchYMD = str.match(/(\d{4})[-/](\d{1,2})[-/](\d{1,2})/);
            if (matchYMD) {
                return new Date(matchYMD[1], matchYMD[2] - 1, matchYMD[3]);
            }
            
            // Intentar parse directo
            const d = new Date(str);
            return isNaN(d.getTime()) ? null : d;
        }

        function verificarHabilitarAnalisis() {
            const btn = document.getElementById('btn-analizar');
            const hayCot = cotizacionesData.length > 0;
            const hayVentas = ventasData.length > 0;
            
            console.log('🔍 Verificando archivos:');
            console.log('  📋 Cotizaciones:', cotizacionesData.length);
            console.log('  💰 Ventas:', ventasData.length);
            
            if (hayCot && hayVentas) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                console.log('✅ Botón ANALIZAR activado');
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                console.log('⏳ Esperando archivos...');
            }
        }

        function analizarCotizaciones() {
            if (cotizacionesData.length === 0 || ventasData.length === 0) {
                alert('Por favor carga ambos archivos primero');
                return;
            }
            
            const resultado = {
                sinCompra: [],
                convertidas: [],
                recientes: []
            };
            
            const hoy = new Date();
            
            cotizacionesData.forEach(cot => {
                // Buscar ventas del mismo cliente (por RUT)
                const ventasCliente = ventasData.filter(v => v.rut === cot.rut);
                
                // Buscar ventas DESPUÉS de la cotización (ventana de 90 días)
                const ventasPosteriores = ventasCliente.filter(v => {
                    if (!v.fecha || !cot.fecha) return false;
                    const diffDias = Math.floor((v.fecha - cot.fecha) / (1000 * 60 * 60 * 24));
                    return diffDias >= 0 && diffDias <= 90;
                });
                
                const diasDesde = Math.floor((hoy - cot.fecha) / (1000 * 60 * 60 * 24));
                
                if (ventasPosteriores.length > 0) {
                    // COMPRÓ - puede haber comprado en una o múltiples facturas
                    // Sumar todas las ventas relacionadas
                    const totalVendido = ventasPosteriores.reduce((sum, v) => sum + v.total, 0);
                    const primeraVenta = ventasPosteriores[0];
                    const diasConversion = Math.floor((primeraVenta.fecha - cot.fecha) / (1000 * 60 * 60 * 24));
                    
                    // Calcular diferencia con más precisión
                    let diferencia = ((totalVendido - cot.monto) / cot.monto) * 100;
                    
                    // Evitar -100.0% exacto, usar -99.99% como máximo para claridad
                    if (diferencia <= -100) {
                        diferencia = -99.99;
                    }
                    
                    // Crear lista de documentos con sus montos
                    const documentosDetalle = ventasPosteriores.map(v => ({
                        numero: v.documento,
                        monto: v.total,
                        items: v.items,
                        fecha: v.fecha
                    }));
                    
                    resultado.convertidas.push({
                        ...cot,
                        montoVendido: totalVendido,
                        diasConversion: diasConversion,
                        diferencia: diferencia,
                        documentoVenta: ventasPosteriores.map(v => v.documento).join(', '),
                        fechaVenta: primeraVenta.fecha,
                        documentosDetalle: documentosDetalle,
                        cantidadFacturas: ventasPosteriores.length
                    });
                } else if (diasDesde <= 3) {
                    // MUY RECIENTE (esperar)
                    resultado.recientes.push({
                        ...cot,
                        diasDesde: diasDesde
                    });
                } else {
                    // NO COMPRÓ
                    resultado.sinCompra.push({
                        ...cot,
                        diasDesde: diasDesde
                    });
                }
            });
            
            // Ordenar por fecha (descendente - más recientes primero)
            resultado.sinCompra.sort((a, b) => {
                if (!a.fecha || !b.fecha) return 0;
                return b.fecha - a.fecha; // Más reciente primero
            });
            resultado.convertidas.sort((a, b) => {
                if (!a.fecha || !b.fecha) return 0;
                return b.fecha - a.fecha; // Más reciente primero
            });
            
            analisisResultado = resultado;
            mostrarResultados(resultado);
        }

        function mostrarResultados(resultado) {
            // Mostrar sección de resultados
            document.getElementById('resultados-cotizaciones').classList.remove('hidden');
            
            // Calcular estadísticas
            const totalCot = cotizacionesData.length;
            const totalConv = resultado.convertidas.length;
            const totalSin = resultado.sinCompra.length;
            const tasaConv = totalCot > 0 ? ((totalConv / totalCot) * 100).toFixed(1) : 0;
            
            const montoSinCompra = resultado.sinCompra.reduce((sum, c) => sum + c.monto, 0);
            
            // Actualizar KPIs
            document.getElementById('total-cotizaciones').textContent = totalCot;
            document.getElementById('total-convertidas').textContent = totalConv;
            document.getElementById('pct-convertidas').textContent = `${tasaConv}%`;
            document.getElementById('total-sin-compra').textContent = totalSin;
            document.getElementById('monto-sin-compra').textContent = CLP.format(montoSinCompra);
            document.getElementById('tasa-conversion').textContent = `${tasaConv}%`;
            
            document.getElementById('count-sin-compra').textContent = totalSin;
            document.getElementById('count-convertidas').textContent = totalConv;
            
            // Renderizar tablas
            renderTablaSinCompra(resultado.sinCompra);
            renderTablaConvertidas(resultado.convertidas);
        }

        function renderTablaSinCompra(datos) {
            const tbody = document.getElementById('tabla-sin-compra');
            tbody.innerHTML = '';
            
            datos.forEach((cot, idx) => {
                const prioridad = cot.monto > 200000 ? '🔥' : (cot.diasDesde > 7 ? '⚠️' : '');
                const cotId = `cot-sin-${idx}`;
                
                tbody.innerHTML += `
                    <tr class="hover:bg-red-50 cursor-pointer" onclick="verDetalleCotizacion('sin', ${idx})">
                        <td class="p-3">
                            <div class="font-bold text-blue-600 text-xs mb-1">COT-${cot.numero}</div>
                            <div class="font-medium text-gray-800">${prioridad} ${cot.cliente}</div>
                        </td>
                        <td class="p-3 text-gray-600 font-mono text-xs">${cot.rut}</td>
                        <td class="p-3 text-right font-bold text-red-600">${CLP.format(cot.monto)}</td>
                        <td class="p-3 text-center text-gray-600 text-sm">${cot.fecha ? cot.fecha.toLocaleDateString('es-CL') : '-'}</td>
                        <td class="p-3 text-center">
                            <span class="px-2 py-1 rounded ${cot.diasDesde > 15 ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'} font-bold text-xs">
                                ${cot.diasDesde} días
                            </span>
                        </td>
                        <td class="p-3 text-gray-600 text-sm">${cot.vendedor}</td>
                    </tr>
                `;
            });
        }

        function renderTablaConvertidas(datos) {
            const tbody = document.getElementById('tabla-convertidas');
            tbody.innerHTML = '';
            
            datos.forEach((cot, idx) => {
                const difPct = cot.diferencia.toFixed(1);
                const difClass = Math.abs(cot.diferencia) < 5 ? 'text-green-600' : 'text-blue-600';
                const estado = Math.abs(cot.diferencia) < 5 ? '✅ Exacta' : (cot.diferencia > 0 ? '📈 Mayor' : '📉 Menor');
                
                tbody.innerHTML += `
                    <tr class="hover:bg-green-50 cursor-pointer" onclick="verDetalleCotizacion('conv', ${idx})">
                        <td class="p-3">
                            <div class="font-bold text-blue-600 text-xs mb-1">
                                COT-${cot.numero} → ${cot.documentoVenta || 'DOC'}
                            </div>
                            <div class="font-medium text-gray-800">${cot.cliente}</div>
                            <div class="text-xs text-gray-500">${cot.fecha ? cot.fecha.toLocaleDateString('es-CL') : '-'}</div>
                        </td>
                        <td class="p-3 text-right text-gray-600">${CLP.format(cot.monto)}</td>
                        <td class="p-3 text-right font-bold text-green-600">${CLP.format(cot.montoVendido)}</td>
                        <td class="p-3 text-right font-bold ${difClass}">${difPct > 0 ? '+' : ''}${difPct}%</td>
                        <td class="p-3 text-center text-gray-600">${cot.diasConversion} días</td>
                        <td class="p-3 text-center text-sm">${estado}</td>
                    </tr>
                `;
            });
        }

        function descargarExcelSeguimiento() {
            if (!analisisResultado || analisisResultado.sinCompra.length === 0) {
                alert('No hay datos para descargar');
                return;
            }
            
            // Ordenar por fecha descendente antes de exportar
            const datosOrdenados = [...analisisResultado.sinCompra].sort((a, b) => {
                if (!a.fecha || !b.fecha) return 0;
                return b.fecha - a.fecha;
            });
            
            const datos = datosOrdenados.map(cot => ({
                'N° Cotización': cot.numero,
                'Fecha Cotización': cot.fecha ? cot.fecha.toLocaleDateString('es-CL') : '',
                'Cliente': cot.cliente,
                'RUT': cot.rut,
                'Monto Cotizado': cot.monto,
                'Días Sin Respuesta': cot.diasDesde,
                'Vendedor': cot.vendedor,
                'Estado': cot.estado || 'Vigente',
                'Prioridad': cot.monto > 200000 ? 'ALTA' : (cot.diasDesde > 7 ? 'MEDIA' : 'NORMAL')
            }));
            
            const ws = XLSX.utils.json_to_sheet(datos);
            
            // Ajustar anchos de columna
            ws['!cols'] = [
                { wch: 12 },  // N° Cot
                { wch: 15 },  // Fecha
                { wch: 35 },  // Cliente
                { wch: 15 },  // RUT
                { wch: 15 },  // Monto
                { wch: 12 },  // Días
                { wch: 20 },  // Vendedor
                { wch: 12 },  // Estado
                { wch: 10 }   // Prioridad
            ];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Seguimiento");
            
            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `SeguimientoCotizaciones_${fecha}.xlsx`);
        }

        function descargarExcelConversiones() {
            if (!analisisResultado || analisisResultado.convertidas.length === 0) {
                alert('No hay datos para descargar');
                return;
            }
            
            // Ordenar por fecha descendente antes de exportar
            const datosOrdenados = [...analisisResultado.convertidas].sort((a, b) => {
                if (!a.fecha || !b.fecha) return 0;
                return b.fecha - a.fecha;
            });
            
            const datos = datosOrdenados.map(cot => ({
                'N° Cotización': cot.numero,
                'N° Documento Venta': cot.documentoVenta || '-',
                'Fecha Cotización': cot.fecha ? cot.fecha.toLocaleDateString('es-CL') : '',
                'Fecha Venta': cot.fechaVenta ? cot.fechaVenta.toLocaleDateString('es-CL') : '',
                'Cliente': cot.cliente,
                'RUT': cot.rut,
                'Monto Cotizado': cot.monto,
                'Monto Vendido': cot.montoVendido,
                'Diferencia %': cot.diferencia.toFixed(2),
                'Días Conversión': cot.diasConversion,
                'Vendedor': cot.vendedor,
                'Estado': cot.estado || 'Vigente'
            }));
            
            const ws = XLSX.utils.json_to_sheet(datos);
            
            // Ajustar anchos de columna
            ws['!cols'] = [
                { wch: 12 },  // N° Cot
                { wch: 18 },  // N° Doc Venta
                { wch: 15 },  // Fecha Cot
                { wch: 15 },  // Fecha Venta
                { wch: 35 },  // Cliente
                { wch: 15 },  // RUT
                { wch: 15 },  // Monto Cotizado
                { wch: 15 },  // Monto Vendido
                { wch: 12 },  // Diferencia
                { wch: 12 },  // Días Conv
                { wch: 20 },  // Vendedor
                { wch: 12 }   // Estado
            ];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Conversiones");
            
            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `ConversionCotizaciones_${fecha}.xlsx`);
        }

        // ============================================
        // MODAL DETALLE COTIZACIÓN
        // ============================================
        
        function verDetalleCotizacion(tipo, index) {
            const cot = tipo === 'sin' ? analisisResultado.sinCompra[index] : analisisResultado.convertidas[index];
            
            const modal = document.getElementById('modal-detalle-cot');
            const titulo = document.getElementById('modal-titulo');
            const subtitulo = document.getElementById('modal-subtitulo');
            const contenido = document.getElementById('modal-contenido');
            
            if (tipo === 'sin') {
                // Cotización SIN COMPRA
                titulo.textContent = 'Cotización Sin Compra';
                subtitulo.textContent = `COT-${cot.numero} • ${cot.fecha ? cot.fecha.toLocaleDateString('es-CL') : 'Sin fecha'}`;
                
                contenido.innerHTML = `
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-xs text-gray-500 uppercase font-bold mb-1">Cliente</div>
                            <div class="font-bold text-gray-800">${cot.cliente}</div>
                            <div class="text-sm text-gray-600 font-mono mt-1">${cot.rut}</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-xs text-gray-500 uppercase font-bold mb-1">Monto Cotizado</div>
                            <div class="font-bold text-2xl text-red-600">${CLP.format(cot.monto)}</div>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <div class="text-xs text-yellow-700 uppercase font-bold mb-1">Días Sin Respuesta</div>
                            <div class="font-bold text-2xl text-yellow-700">${cot.diasDesde}</div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <div class="text-xs text-blue-700 uppercase font-bold mb-1">Vendedor</div>
                            <div class="font-bold text-blue-700">${cot.vendedor || 'No asignado'}</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="text-xs text-gray-700 uppercase font-bold mb-1">Estado</div>
                            <div class="font-bold text-gray-700">${cot.estado || 'Vigente'}</div>
                        </div>
                    </div>
                    
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                            <div class="font-bold text-red-800">Acción Requerida</div>
                        </div>
                        <p class="text-sm text-red-700">
                            Esta cotización lleva <strong>${cot.diasDesde} días</strong> sin convertirse en venta. 
                            ${cot.diasDesde > 15 ? 'Se recomienda contacto urgente.' : 'Realizar seguimiento.'}
                        </p>
                    </div>
                    
                    <div class="mt-6 text-xs text-gray-500">
                        <strong>Nota:</strong> Los detalles de productos cotizados no están disponibles en el reporte de Bsale. 
                        Para ver los productos, accede directamente a la cotización en Bsale.
                    </div>
                `;
                
            } else {
                // Cotización CONVERTIDA
                titulo.textContent = 'Cotización Convertida ✅';
                subtitulo.textContent = `COT-${cot.numero} → ${cot.documentoVenta}`;
                
                const difPct = cot.diferencia.toFixed(1);
                const difColor = Math.abs(cot.diferencia) < 5 ? 'green' : (cot.diferencia > 0 ? 'blue' : 'orange');
                
                // Crear tabla de documentos si hay múltiples
                let documentosHtml = '';
                if (cot.documentosDetalle && cot.documentosDetalle.length > 0) {
                    documentosHtml = `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <div class="font-bold text-blue-800 mb-3 flex items-center gap-2">
                                <i class="fas fa-file-invoice"></i>
                                Documentos de Venta Generados (${cot.cantidadFacturas})
                            </div>
                            <div class="space-y-2">
                                ${cot.documentosDetalle.map(doc => `
                                    <div class="bg-white p-3 rounded flex justify-between items-center">
                                        <div>
                                            <div class="font-bold text-gray-800">${doc.numero}</div>
                                            <div class="text-xs text-gray-500">${doc.fecha ? doc.fecha.toLocaleDateString('es-CL') : '-'} • ${doc.items} item(s)</div>
                                        </div>
                                        <div class="font-bold text-green-600">${CLP.format(doc.monto)}</div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mt-3 pt-3 border-t border-blue-200 flex justify-between items-center font-bold">
                                <span class="text-blue-800">Total Vendido:</span>
                                <span class="text-green-600 text-lg">${CLP.format(cot.montoVendido)}</span>
                            </div>
                        </div>
                    `;
                }
                
                // Análisis de conversión
                let analisisConversion = '';
                const porcentajeComprado = (cot.montoVendido / cot.monto) * 100;
                
                if (Math.abs(cot.diferencia) < 5) {
                    analisisConversion = '✅ La cotización se convirtió casi exactamente. Excelente cierre.';
                } else if (porcentajeComprado < 10) {
                    analisisConversion = '⚠️ El cliente compró menos del 10% de lo cotizado ($' + CLP.format(cot.montoVendido) + ' de $' + CLP.format(cot.monto) + '). Muy probablemente compró productos diferentes a los cotizados o realizó una compra de prueba/muestra.';
                } else if (cot.diferencia < -80) {
                    analisisConversion = '📉 El cliente compró mucho menos de lo cotizado. Posible compra parcial, cambio de presupuesto significativo, o compró solo algunos items de la cotización.';
                } else if (cot.diferencia < -20) {
                    analisisConversion = '📉 El cliente compró significativamente menos. Posible recorte de presupuesto o compra parcial.';
                } else if (cot.diferencia > 20) {
                    analisisConversion = '📈 El cliente compró significativamente más de lo cotizado. Posible upselling exitoso.';
                } else if (cot.diferencia > 5) {
                    analisisConversion = '📈 El cliente compró un poco más de lo cotizado.';
                } else {
                    analisisConversion = '📉 El cliente compró un poco menos de lo cotizado.';
                }
                
                contenido.innerHTML = `
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-xs text-gray-500 uppercase font-bold mb-1">Cliente</div>
                            <div class="font-bold text-gray-800">${cot.cliente}</div>
                            <div class="text-sm text-gray-600 font-mono mt-1">${cot.rut}</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <div class="text-xs text-green-700 uppercase font-bold mb-1">Estado</div>
                            <div class="font-bold text-green-700">✅ CONVERTIDA</div>
                            <div class="text-xs text-green-600 mt-1">${cot.cantidadFacturas} documento(s) de venta</div>
                        </div>
                    </div>
                    
                    <div class="bg-white border-2 border-gray-200 rounded-lg p-6 mb-6">
                        <div class="text-center mb-4">
                            <div class="text-sm text-gray-600 mb-2">Flujo de Conversión</div>
                            <div class="flex items-center justify-center gap-4">
                                <div class="text-center">
                                    <div class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg font-bold">
                                        COT-${cot.numero}
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">${cot.fecha ? cot.fecha.toLocaleDateString('es-CL') : '-'}</div>
                                </div>
                                <i class="fas fa-arrow-right text-2xl text-gray-400"></i>
                                <div class="text-center">
                                    <div class="bg-green-100 text-green-700 px-4 py-2 rounded-lg font-bold">
                                        ${cot.cantidadFacturas > 1 ? `${cot.cantidadFacturas} Docs` : cot.documentoVenta}
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">${cot.fechaVenta ? cot.fechaVenta.toLocaleDateString('es-CL') : '-'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${documentosHtml}
                    
                    <div class="bg-gradient-to-r from-blue-50 to-green-50 border-2 border-gray-200 rounded-lg p-6 mb-6">
                        <div class="text-center mb-4">
                            <div class="text-sm text-gray-600 font-bold mb-3">COMPARACIÓN</div>
                        </div>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-xs text-blue-600 uppercase font-bold mb-1">Cotizado</div>
                                <div class="font-bold text-2xl text-blue-700">${CLP.format(cot.monto)}</div>
                            </div>
                            <div class="text-center flex items-center justify-center">
                                <i class="fas fa-exchange-alt text-3xl text-gray-400"></i>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-green-600 uppercase font-bold mb-1">Vendido Real</div>
                                <div class="font-bold text-2xl text-green-700">${CLP.format(cot.montoVendido)}</div>
                            </div>
                        </div>
                        <div class="mt-4 text-center">
                            <div class="inline-block bg-${difColor}-100 border-2 border-${difColor}-300 px-6 py-3 rounded-lg">
                                <div class="text-xs text-${difColor}-600 uppercase font-bold mb-1">Diferencia</div>
                                <div class="font-bold text-3xl text-${difColor}-700">${difPct > 0 ? '+' : ''}${difPct}%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                            <div class="text-xs text-purple-700 uppercase font-bold mb-1">Días Conversión</div>
                            <div class="font-bold text-xl text-purple-700">${cot.diasConversion}</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="text-xs text-gray-700 uppercase font-bold mb-1">Vendedor</div>
                            <div class="font-bold text-gray-700">${cot.vendedor || '-'}</div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <div class="text-xs text-blue-700 uppercase font-bold mb-1">Items Vendidos</div>
                            <div class="font-bold text-xl text-blue-700">${cot.documentosDetalle ? cot.documentosDetalle.reduce((sum, d) => sum + d.items, 0) : '-'}</div>
                        </div>
                    </div>
                    
                    ${(cot.montoVendido / cot.monto * 100) < 10 ? `
                        <div class="bg-orange-50 border-l-4 border-orange-500 p-4 rounded mb-4">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-exclamation-circle text-orange-600"></i>
                                <div class="font-bold text-orange-800">⚠️ Compra Muy Pequeña Detectada</div>
                            </div>
                            <p class="text-sm text-orange-700">
                                El cliente compró menos del 10% de lo cotizado. Esto podría indicar:
                            </p>
                            <ul class="text-sm text-orange-700 mt-2 ml-4 space-y-1">
                                <li>• Compró productos diferentes a los cotizados</li>
                                <li>• Orden de prueba o muestra</li>
                                <li>• Cambio significativo en el requerimiento</li>
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-check-circle text-green-600"></i>
                            <div class="font-bold text-green-800">Análisis de Conversión</div>
                        </div>
                        <p class="text-sm text-green-700 mb-2">
                            ${analisisConversion}
                        </p>
                        <p class="text-sm text-green-700">
                            La cotización se convirtió en venta en <strong>${cot.diasConversion} días</strong>.
                        </p>
                    </div>
                    
                    <div class="mt-6 text-xs text-gray-500">
                        <strong>Nota:</strong> El monto vendido incluye todos los documentos generados relacionados con esta cotización.
                    </div>
                `;
            }
            
            modal.classList.remove('hidden');
        }
        
        function cerrarModalDetalle() {
            document.getElementById('modal-detalle-cot').classList.add('hidden');
        }
        
        // Cerrar modal al hacer clic fuera
        document.getElementById('modal-detalle-cot')?.addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalDetalle();
            }
        });
    </script>
</body>
</html>
