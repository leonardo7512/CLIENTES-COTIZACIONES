<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard V7 - Inteligencia de Ventas (Action Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f1f5f9; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .card { background: white; border-radius: 10px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .scroll-area { overflow-y: auto; scrollbar-width: thin; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .action-btn { transition: all 0.2s; }
        .action-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="text-slate-800">

    <div class="bg-slate-900 text-white px-6 py-3 shadow-md z-20 shrink-0 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="bg-indigo-600 w-10 h-10 rounded-lg flex items-center justify-center font-bold text-lg shadow-lg shadow-indigo-500/50">
                <i class="fas fa-brain"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-tight">Monitor de Oportunidades</h1>
                <div class="text-xs text-slate-400 font-mono" id="last-update">Esperando datos...</div>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
             <label class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg text-sm font-bold cursor-pointer transition flex items-center gap-2 shadow-lg shadow-indigo-500/30">
                <i class="fas fa-cloud-upload-alt"></i> Subir Ventas
                <input type="file" id="upload-csv" accept=".csv,.xlsx,.xls" class="hidden" />
            </label>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-80 bg-white border-r flex flex-col z-10">
            <div class="p-4 border-b bg-slate-50">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                    <input type="text" id="search-input" placeholder="Buscar Cliente..." 
                           class="w-full pl-9 pr-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none text-sm font-semibold uppercase">
                </div>
                <div class="flex gap-1 mt-2">
                    <button onclick="filterList('opportunity')" class="flex-1 py-1.5 text-xs font-bold text-white bg-emerald-500 rounded hover:bg-emerald-600 transition">Oportunidades</button>
                    <button onclick="filterList('risk')" class="flex-1 py-1.5 text-xs font-bold text-white bg-amber-500 rounded hover:bg-amber-600 transition">En Riesgo</button>
                    <button onclick="filterList('all')" class="flex-1 py-1.5 text-xs font-bold text-slate-600 bg-slate-200 rounded hover:bg-slate-300 transition">Todos</button>
                </div>
            </div>
            <div id="clients-list" class="flex-1 scroll-area bg-slate-50">
                <div class="p-10 text-center text-slate-400 text-sm opacity-60">
                    <i class="fas fa-arrow-up text-2xl mb-2"></i><br>Carga tu Excel de Ventas para detectar oportunidades
                </div>
            </div>
        </div>

        <div class="flex-1 bg-slate-100 scroll-area p-6 relative">
            
            <div id="dashboard-view" class="max-w-6xl mx-auto space-y-6 hidden">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card p-5 border-t-4 border-amber-500 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-3 opacity-10 text-amber-600 text-6xl"><i class="fas fa-clock"></i></div>
                        <h3 class="font-bold text-slate-700 text-sm uppercase tracking-wide mb-1">Reposici칩n Pendiente</h3>
                        <p class="text-xs text-slate-500 mb-3">Clientes que rompieron su ciclo habitual de compra.</p>
                        <div class="text-3xl font-bold text-slate-800 mb-2" id="kpi-late-count">0</div>
                        <button onclick="showActionList('late')" class="text-xs font-bold text-amber-600 hover:text-amber-800 flex items-center gap-1 action-btn">
                            Ver listado para llamar <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>

                    <div class="card p-5 border-t-4 border-emerald-500 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-3 opacity-10 text-emerald-600 text-6xl"><i class="fas fa-shopping-basket"></i></div>
                        <h3 class="font-bold text-slate-700 text-sm uppercase tracking-wide mb-1">Oportunidad Cross-Selling</h3>
                        <p class="text-xs text-slate-500 mb-3">Clientes VIP que <strong>nunca</strong> han comprado tus Top Productos.</p>
                        <div class="text-3xl font-bold text-slate-800 mb-2" id="kpi-cross-count">0</div>
                        <button onclick="showActionList('cross')" class="text-xs font-bold text-emerald-600 hover:text-emerald-800 flex items-center gap-1 action-btn">
                            Ver oportunidades <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>

                    <div class="card p-5 border-t-4 border-red-500 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-3 opacity-10 text-red-600 text-6xl"><i class="fas fa-chart-line-down"></i></div>
                        <h3 class="font-bold text-slate-700 text-sm uppercase tracking-wide mb-1">Alerta Ticket Promedio</h3>
                        <p class="text-xs text-slate-500 mb-3">Clientes comprando, pero mucho menos que antes.</p>
                        <div class="text-3xl font-bold text-slate-800 mb-2" id="kpi-drop-count">0</div>
                        <button onclick="showActionList('drop')" class="text-xs font-bold text-red-600 hover:text-red-800 flex items-center gap-1 action-btn">
                            Ver qui칠n compra menos <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <div id="action-container" class="hidden animate-fade-in mb-8">
                    <div class="bg-white rounded-lg shadow-lg border border-slate-200 overflow-hidden">
                        <div class="bg-slate-50 px-6 py-4 border-b flex justify-between items-center">
                            <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2" id="action-title">
                                </h3>
                            <button onclick="document.getElementById('action-container').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="p-0 overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                                    <tr>
                                        <th class="px-6 py-3">Cliente</th>
                                        <th class="px-6 py-3" id="col-metric">M칠trica</th>
                                        <th class="px-6 py-3">Diagn칩stico</th>
                                        <th class="px-6 py-3 text-right">Acci칩n</th>
                                    </tr>
                                </thead>
                                <tbody id="action-table-body" class="divide-y divide-slate-100">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex flex-wrap gap-8 items-center justify-between">
                    <div>
                        <div class="text-xs uppercase font-bold text-slate-400">Venta Total Neta</div>
                        <div class="text-2xl font-bold text-indigo-700" id="global-neto">$ -</div>
                    </div>
                    <div>
                        <div class="text-xs uppercase font-bold text-slate-400">Total Clientes</div>
                        <div class="text-2xl font-bold text-slate-700" id="global-clients">-</div>
                    </div>
                    <div>
                        <div class="text-xs uppercase font-bold text-slate-400">Ticket Promedio Global</div>
                        <div class="text-2xl font-bold text-slate-700" id="global-ticket">-</div>
                    </div>
                    <div class="h-10 w-px bg-slate-200"></div>
                     <div>
                        <div class="text-xs uppercase font-bold text-slate-400">Top Producto</div>
                        <div class="text-sm font-bold text-slate-600 max-w-[200px] truncate" id="global-top-prod">-</div>
                    </div>
                </div>

            </div>

            <div id="detail-view" class="hidden max-w-5xl mx-auto">
                <button onclick="closeDetail()" class="mb-4 text-xs font-bold text-slate-500 hover:text-indigo-600 flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> Volver al Dashboard
                </button>

                <div class="bg-white rounded-lg shadow-lg border-t-4 border-indigo-500 overflow-hidden">
                    <div class="p-6 bg-white border-b">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800" id="det-name">CLIENTE</h2>
                                <div class="text-sm text-slate-500 font-mono mt-1" id="det-rut">RUT</div>
                            </div>
                            <div id="det-tags" class="flex gap-2">
                                </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                            <div class="bg-slate-50 p-3 rounded">
                                <div class="text-xs text-slate-400 uppercase font-bold">Frecuencia Compra</div>
                                <div class="text-lg font-bold text-indigo-600" id="det-freq">0 d칤as</div>
                                <div class="text-xs text-slate-500">Promedio hist칩rico</div>
                            </div>
                            <div class="bg-slate-50 p-3 rounded">
                                <div class="text-xs text-slate-400 uppercase font-bold">칔ltima Compra</div>
                                <div class="text-lg font-bold text-slate-700" id="det-last">Hace 0 d칤as</div>
                                <div class="text-xs text-slate-500" id="det-last-date">-</div>
                            </div>
                             <div class="bg-slate-50 p-3 rounded">
                                <div class="text-xs text-slate-400 uppercase font-bold">Ticket Promedio</div>
                                <div class="text-lg font-bold text-slate-700" id="det-avg-ticket">$0</div>
                            </div>
                            <div class="bg-slate-50 p-3 rounded">
                                <div class="text-xs text-slate-400 uppercase font-bold">Potencial</div>
                                <div class="text-lg font-bold text-emerald-600" id="det-potential">Normal</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2">
                        <div class="p-6 border-r">
                            <h3 class="font-bold text-slate-700 mb-4 text-sm uppercase">Lo que m치s compra</h3>
                            <div id="det-top-products" class="space-y-2"></div>
                        </div>
                        <div class="p-6 bg-slate-50">
                            <h3 class="font-bold text-indigo-700 mb-4 text-sm uppercase"><i class="fas fa-lightbulb"></i> Recomendaciones IA</h3>
                            <div id="det-recommendations" class="space-y-3">
                                </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const CLP = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });
        let DB = { clients: {}, products: {}, invoices: [] };
        let ActionLists = { late: [], cross: [], drop: [] };
        let currentList = [];

        // 1. LECTURA Y LIMPIEZA
        function parseCLP(val) {
            if (typeof val === 'number') return val;
            if (!val) return 0;
            let str = val.toString().trim();
            if (str.includes(',')) { // Formato CL 1.000,00
                 str = str.replace(/\./g, '').replace(',', '.');
            } else { // Formato US 1,000.00 (a veces pasa)
                 // Asumimos CL puro si no hay conflicto, simplificado:
                 str = str.replace(/\./g, ''); 
            }
            return parseFloat(str) || 0;
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            if (dateStr instanceof Date) return dateStr;
            const parts = dateStr.toString().split(/[-/]/);
            // Asumimos DD/MM/YYYY o YYYY-MM-DD
            if (parts.length === 3) {
                if (parts[0].length === 4) return new Date(parts[0], parts[1]-1, parts[2]); // YYYY-MM-DD
                return new Date(parts[2], parts[1]-1, parts[0]); // DD-MM-YYYY
            }
            return new Date(dateStr);
        }

        document.getElementById('upload-csv').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: '' });
                processData(json);
            };
            reader.readAsArrayBuffer(file);
        });

        // 2. PROCESAMIENTO INTELIGENTE
        function processData(rows) {
            // Reiniciar
            DB = { clients: {}, products: {}, invoices: [] };
            if (rows.length < 2) return;

            const headers = rows[0].map(h => String(h).toLowerCase().trim());
            // Detectar 칤ndices din치micamente
            const idx = {
                cliente: headers.findIndex(h => h.includes('cliente') || h.includes('razon social')),
                rut: headers.findIndex(h => h.includes('rut')),
                fecha: headers.findIndex(h => h.includes('fecha')),
                total: headers.findIndex(h => h.includes('total') || h.includes('monto')),
                producto: headers.findIndex(h => h.includes('producto') || h.includes('detalle')),
                cantidad: headers.findIndex(h => h.includes('cantidad')),
                doc: headers.findIndex(h => h.includes('documento') || h.includes('folio'))
            };

            let grandTotal = 0;

            // Iterar datos
            rows.slice(1).forEach(row => {
                if (!row[idx.cliente] && !row[idx.total]) return;

                const rawTotal = row[idx.total];
                if (String(rawTotal).toUpperCase().includes('TOTAL')) return; // Fila de totales del excel

                const clientName = String(row[idx.cliente]).trim().toUpperCase();
                const rut = String(row[idx.rut] || '').trim().toUpperCase();
                const fecha = parseDate(row[idx.fecha]);
                const total = parseCLP(rawTotal);
                const prod = String(row[idx.producto] || '').trim().toUpperCase();
                const qty = parseCLP(row[idx.cantidad]);
                const docId = String(row[idx.doc] || 'S/F');

                if (total === 0 && !prod) return;

                grandTotal += total;

                // Construir Productos Globales
                if (prod) {
                    if (!DB.products[prod]) DB.products[prod] = { name: prod, total: 0, qty: 0, clients: new Set() };
                    DB.products[prod].total += total;
                    DB.products[prod].qty += qty;
                    DB.products[prod].clients.add(clientName);
                }

                // Construir Clientes
                if (!DB.clients[clientName]) {
                    DB.clients[clientName] = {
                        name: clientName,
                        rut: rut,
                        invoices: {}, // Agrupar por documento para no duplicar fechas
                        products: {},
                        totalSpent: 0,
                        firstDate: fecha,
                        lastDate: fecha
                    };
                }

                const c = DB.clients[clientName];
                c.totalSpent += total;
                if (fecha < c.firstDate) c.firstDate = fecha;
                if (fecha > c.lastDate) c.lastDate = fecha;

                // Guardar factura 칰nica (clave: Doc + Fecha)
                const invKey = docId + '_' + fecha.getTime();
                if (!c.invoices[invKey]) {
                    c.invoices[invKey] = { date: fecha, total: 0 };
                }
                c.invoices[invKey].total += total;

                // Guardar producto por cliente
                if (prod) {
                    if (!c.products[prod]) c.products[prod] = 0;
                    c.products[prod] += total; // Valor monetario del producto para este cliente
                }
            });

            analyzeInsights(grandTotal);
        }

        // 3. GENERACI칍N DE INSIGHTS (EL CEREBRO)
        function analyzeInsights(grandTotal) {
            const today = new Date(); // Asumimos hoy, en prod real usar maxDate del archivo si es hist칩rico muy viejo
            
            // A. Top Productos Globales (Para Cross-Selling)
            const topProducts = Object.values(DB.products)
                .sort((a,b) => b.total - a.total)
                .slice(0, 5) // Top 5 productos
                .map(p => p.name);

            // Listas de Acci칩n
            ActionLists = { late: [], cross: [], drop: [] };
            
            const clientArray = Object.values(DB.clients).map(c => {
                // M칠tricas b치sicas
                const invoicesList = Object.values(c.invoices).sort((a,b) => a.date - b.date);
                const invoiceCount = invoicesList.length;
                const daysActive = (c.lastDate - c.firstDate) / (1000 * 60 * 60 * 24);
                
                // 1. Frecuencia Personalizada
                let avgDaysBetween = 0;
                if (invoiceCount > 1) {
                    avgDaysBetween = daysActive / (invoiceCount - 1);
                } else {
                    avgDaysBetween = 30; // Default si solo hay 1 compra
                }

                const daysSinceLast = Math.floor((today - c.lastDate) / (1000 * 60 * 60 * 24));
                
                // DETECCI칍N: REPOSICI칍N TARDE (LATE)
                // Si lleva m치s del 150% de SU ciclo habitual sin comprar y ha comprado al menos 3 veces antes
                let status = 'active';
                let alertLate = false;
                if (invoiceCount >= 2 && daysSinceLast > (avgDaysBetween * 1.5) && daysSinceLast < 180) { // Menos de 180 para no llamar muertos
                    alertLate = true;
                    status = 'risk';
                    ActionLists.late.push({
                        client: c,
                        metric: `${daysSinceLast} d칤as sin compra`,
                        diag: `Su ciclo es cada ${Math.round(avgDaysBetween)} d칤as. Retraso de ${daysSinceLast - Math.round(avgDaysBetween)} d칤as.`,
                        action: 'Llamar para reposici칩n'
                    });
                }

                // DETECCI칍N: VENTA CRUZADA (CROSS)
                // Si es un cliente bueno (Ticket > Promedio) y NO ha comprado el Top 1 o 2
                // C치lculo simple de ticket promedio global para referencia (aprox)
                // Para demo, asumimos que si gast칩 > $100.000 es "bueno"
                let opportunities = [];
                if (c.totalSpent > 100000) {
                    topProducts.forEach(tp => {
                        if (!c.products[tp]) {
                            opportunities.push(tp);
                        }
                    });
                    
                    if (opportunities.length > 0) {
                        ActionLists.cross.push({
                            client: c,
                            metric: `Potencial Alto ($${(c.totalSpent/1000).toFixed(0)}k comprados)`,
                            diag: `Cliente frecuente pero no conoce: ${opportunities[0]}`,
                            action: `Ofrecer ${opportunities[0]}`
                        });
                    }
                }

                // DETECCI칍N: CA칈DA DE TICKET (DROP)
                // Comparar 칰ltima compra vs su promedio hist칩rico
                const totalInvoicesVal = invoicesList.reduce((sum, inv) => sum + inv.total, 0);
                const avgTicket = totalInvoicesVal / invoiceCount;
                const lastTicket = invoicesList[invoicesList.length - 1].total;

                if (invoiceCount >= 3 && lastTicket < (avgTicket * 0.5)) {
                    ActionLists.drop.push({
                        client: c,
                        metric: `Ca칤da del -${Math.round((1 - lastTicket/avgTicket)*100)}%`,
                        diag: `Ticket promedio: ${CLP.format(avgTicket)}. 칔ltima compra: ${CLP.format(lastTicket)}.`,
                        action: 'Indagar motivo de baja compra'
                    });
                }

                return {
                    ...c,
                    avgDaysBetween,
                    daysSinceLast,
                    avgTicket,
                    status,
                    topOpportunity: opportunities[0] || null
                };
            });

            // Ordenar listas de acci칩n por prioridad (Monto total del cliente)
            ActionLists.late.sort((a,b) => b.client.totalSpent - a.client.totalSpent);
            ActionLists.cross.sort((a,b) => b.client.totalSpent - a.client.totalSpent);
            ActionLists.drop.sort((a,b) => b.client.totalSpent - a.client.totalSpent);

            // Actualizar UI Global
            document.getElementById('last-update').innerText = `Actualizado: ${new Date().toLocaleTimeString()}`;
            document.getElementById('dashboard-view').classList.remove('hidden');
            
            document.getElementById('global-neto').innerText = CLP.format(grandTotal);
            document.getElementById('global-clients').innerText = clientArray.length;
            document.getElementById('global-ticket').innerText = CLP.format(grandTotal / (Object.keys(DB.clients).length || 1));
            document.getElementById('global-top-prod').innerText = topProducts[0] || 'N/A';

            // Actualizar Contadores de Acci칩n
            document.getElementById('kpi-late-count').innerText = ActionLists.late.length;
            document.getElementById('kpi-cross-count').innerText = ActionLists.cross.length;
            document.getElementById('kpi-drop-count').innerText = ActionLists.drop.length;

            currentList = clientArray.sort((a,b) => b.totalSpent - a.totalSpent);
            renderClientList(currentList);
        }

        // 4. RENDERIZADO UI
        function renderClientList(list) {
            const container = document.getElementById('clients-list');
            container.innerHTML = '';
            
            list.slice(0, 100).forEach(c => {
                let borderClass = 'border-l-4 border-transparent';
                let statusIcon = '';
                
                if (c.status === 'risk') { 
                    borderClass = 'border-l-4 border-amber-500 bg-amber-50'; 
                    statusIcon = '<i class="fas fa-clock text-amber-500" title="Tard칤o"></i>';
                }
                if (c.topOpportunity) {
                    statusIcon += ' <i class="fas fa-star text-emerald-500" title="Oportunidad"></i>';
                }

                const div = document.createElement('div');
                div.className = `p-4 border-b hover:bg-white cursor-pointer transition ${borderClass}`;
                div.onclick = () => showDetail(c);
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <div class="font-bold text-slate-700 text-sm truncate w-3/4">${c.name}</div>
                        <div class="text-xs font-bold text-indigo-600">${CLP.format(c.totalSpent)}</div>
                    </div>
                    <div class="flex justify-between items-center text-xs text-slate-500">
                        <div>Hace ${c.daysSinceLast} d칤as ${statusIcon}</div>
                        <div>Ciclo: ${Math.round(c.avgDaysBetween)} d칤as</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function showActionList(type) {
            const container = document.getElementById('action-container');
            const tbody = document.getElementById('action-table-body');
            const title = document.getElementById('action-title');
            const metricHeader = document.getElementById('col-metric');
            
            container.classList.remove('hidden');
            tbody.innerHTML = '';

            let data = ActionLists[type];
            let titleText = '';
            let colorClass = '';

            if (type === 'late') {
                titleText = '游 Clientes para Reposici칩n (Llamar Hoy)';
                metricHeader.innerText = 'D칤as sin compra';
                colorClass = 'text-amber-600';
            } else if (type === 'cross') {
                titleText = '游꿢 Oportunidades de Venta Cruzada';
                metricHeader.innerText = 'Valor Cliente';
                colorClass = 'text-emerald-600';
            } else if (type === 'drop') {
                titleText = '游늴 Alerta: Bajada de Compra';
                metricHeader.innerText = 'Ca칤da %';
                colorClass = 'text-red-600';
            }

            title.innerHTML = `<span class="${colorClass}">${titleText}</span> <span class="text-sm font-normal text-slate-500 ml-2">(${data.length} casos)</span>`;

            data.slice(0, 50).forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-slate-50 cursor-pointer";
                tr.onclick = () => showDetail(item.client);
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-slate-900">${item.client.name}</td>
                    <td class="px-6 py-4 font-bold ${colorClass}">${item.metric}</td>
                    <td class="px-6 py-4 text-slate-500 text-xs">${item.diag}</td>
                    <td class="px-6 py-4 text-right">
                        <button class="bg-indigo-50 text-indigo-600 hover:bg-indigo-100 px-3 py-1 rounded text-xs font-bold border border-indigo-200">
                            ${item.action}
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Scroll to list
            container.scrollIntoView({ behavior: 'smooth' });
        }

        function showDetail(c) {
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('detail-view').classList.remove('hidden');

            document.getElementById('det-name').innerText = c.name;
            document.getElementById('det-rut').innerText = c.rut;
            
            document.getElementById('det-freq').innerText = Math.round(c.avgDaysBetween) + " d칤as";
            document.getElementById('det-last').innerText = "Hace " + c.daysSinceLast + " d칤as";
            document.getElementById('det-last-date').innerText = c.lastDate.toLocaleDateString();
            document.getElementById('det-avg-ticket').innerText = CLP.format(c.avgTicket);

            // Tags
            const tagsDiv = document.getElementById('det-tags');
            tagsDiv.innerHTML = '';
            if (c.totalSpent > 500000) tagsDiv.innerHTML += '<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-bold">VIP</span>';
            if (c.status === 'risk') tagsDiv.innerHTML += '<span class="px-2 py-1 bg-amber-100 text-amber-700 rounded text-xs font-bold">RIESGO</span>';

            // Top Products
            const sortedProds = Object.entries(c.products).sort(([,a], [,b]) => b - a).slice(0, 5);
            document.getElementById('det-top-products').innerHTML = sortedProds.map(([name, total]) => `
                <div class="flex justify-between text-sm py-1 border-b border-slate-100">
                    <span class="text-slate-600 truncate w-2/3">${name}</span>
                    <span class="font-bold text-slate-800">${CLP.format(total)}</span>
                </div>
            `).join('');

            // AI Recommendations (Hardcoded logic based on gaps)
            const recDiv = document.getElementById('det-recommendations');
            recDiv.innerHTML = '';
            
            let recs = [];
            // 1. Cross Sell
            if (c.topOpportunity) {
                recs.push(`<div class="p-3 bg-emerald-50 border border-emerald-200 rounded text-sm text-emerald-800">
                    <strong>Op. Venta Cruzada:</strong> Este cliente gasta bien pero nunca ha llevado <u>${c.topOpportunity}</u>. Ofrecer descuento de prueba.
                </div>`);
            }
            // 2. Late
            if (c.status === 'risk') {
                recs.push(`<div class="p-3 bg-amber-50 border border-amber-200 rounded text-sm text-amber-800">
                    <strong>Reposici칩n Tarde:</strong> Basado en su historial, debi칩 comprar hace ${c.daysSinceLast - Math.round(c.avgDaysBetween)} d칤as. Llamar ya.
                </div>`);
            }
            // 3. Generic
            if (recs.length === 0) {
                recs.push(`<div class="p-3 bg-slate-50 border border-slate-200 rounded text-sm text-slate-600">
                    Sin alertas cr칤ticas. Mantener contacto regular. Pr칩xima compra estimada en ${(Math.round(c.avgDaysBetween) - c.daysSinceLast)} d칤as.
                </div>`);
            }
            recDiv.innerHTML = recs.join('');
        }

        function closeDetail() {
            document.getElementById('detail-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
        }

        function filterList(type) {
            if (type === 'all') renderClientList(currentList);
            if (type === 'risk') renderClientList(currentList.filter(c => c.status === 'risk'));
            if (type === 'opportunity') renderClientList(currentList.filter(c => c.topOpportunity));
        }

        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toUpperCase();
            renderClientList(currentList.filter(c => c.name.includes(term)));
        });

    </script>
</body>
</html>
